!function(a){define(function(require,b,c){function d(){var b=l.getLoginInfo(),c=b.username,d=b.password,e=b.logintype,f=a("#pre_type").val()-0;"ActiveDirectory"===e&&(f=13),"LDAP"===e&&(f=12),plugin.login(c,d,f).done(function(){m.leave(),webApp.IsSDIntel&&k.DevIntelliTracker.start(),require.async("index_page",function(b){m.indexPage=new b({element:a("#main").translation()})})})}function e(){plugin.logout(),l.logout()}var f,g=require("/jsCore/pageBase"),h=require("common/common"),i=h.Cookie,j=h.Check,k=(require("/jsCore/ability"),require("/jsCore/rpc")),l=require("/jsCore/rpcLogin"),m=null,n=null;c.exports=g.extend({init:function(){if(m=this,m.$("#login_user").textfield(),m.$("#login_psw").textfield().on("keydown",function(a){13===a.keyCode&&(m.$("#login_psw").blur(),m.$("[btn-for=onLogin]").click())}),n=m.$("#login_modify").dialog({confirm:function(){return f.isInvalid()?f.validate():(n.closeFlag=!0,n.dialog("close"),n.closeFlag=!1,void k.MagicBox.getSerialNo().done(function(b){var c,e,f="Login to "+b,g=l.getLoginInfo(),h=n.find("[name=newpwd]").textfield("value");webApp.EncryptInfo&&webApp.EncryptInfo.asymmetric&&webCaps.OnvifSync?(c=h,e=g.password):(c=hex_md5(g.username+":"+f+":"+h),e=hex_md5(g.username+":"+f+":"+g.password)),k.UserManager.modifyPassword(g.username,c,e).done(function(){l.getLoginInfo().password=n.find("[name=newpwd]").textfield("value"),d()}).fail(function(b){var c=b.error.code,d="w_ChangePwdFail";switch(c){case 604:d="w_useMannageErr_InputNotValid";break;case 605:d="w_useMannageErr_IndexOverlap_user";break;case 606:case 607:d="w_useMannageErr_ObjectNotValid_user";break;case 608:d="w_useMannageErr_ObjectInUse_user";break;case 609:d="w_useMannageErr_SubsetOverlap_user";break;case 610:d="w_useMannageErr_SaveCfgError";break;case 611:d="w_useMannageErr_PwdNotValid";break;case 612:d="w_useMannageErr_PwdNotMatch";break;case 613:d="w_useMannageErr_ReservedAccount";break;case 614:d="w_useMannageErr_TooManyGroup";break;case 615:d="w_useMannageErr_TooManyUser"}a.alert(tl(d))})}))},close:function(){!n.closeFlag&&d()}}).detach().appendTo(document.body),n.find(":checkbox").on("change",function(a){i.set("pwdNoTip",a.target.checked?1:0,{expires:365})}),n.find("[name=newpwd2]").textfield({success:a.noop}),n.find("[name=newpwd]").textfield({success:a.noop}).on("keyup",function(){var a=h.pwdStrenthValidator(this.value),b=n.find(".ui-pwd-strength");b.find("li").removeClass("current"),this.value?(b.find("li."+a).addClass("current"),b.removeClass().addClass("ui-pwd-strength").addClass(a)):b.removeClass().addClass("ui-pwd-strength")}),f=a.validator([{element:n.find("[name=newpwd]"),check:[j.require,j.noQuotationColonAnd],errorMsg:[tl("w_passwordMustnotNull"),tl("badPwdString")],events:["keyup","keyup"],errorElem:".u-input-error"},{element:n.find("[name=newpwd2]"),check:[j.require,function(a){return a===n.find("[name=newpwd]").val()},j.noQuotationColonAnd],errorMsg:[tl("w_passwordMustnotNull"),tl("w_PwdDif"),tl("badPwdString")],events:["keyup","keyup","keyup"],errorElem:".u-input-error"}]),"Dahua"===webApp.Vendor)m.$("#login_logo").addClass("login-logo-dahua"),a("#main_logo").addClass("main-logo-dahua");else if(-1===webApp.DeviceType.indexOf("SD"))m.$("#login_logo").addClass("login-logo"),a("#main_logo").addClass("main-logo");else switch(webApp.DeviceSubClass){case"SDC":m.$("#login_logo").addClass("login-logo-ipdome"),a("#main_logo").addClass("main-logo-ipdome");break;case"SD_CA":case"SD_CA_ICT":m.$("#login_logo").addClass("login-logo"),a("#main_logo").addClass("main-logo");break;case"SD_PTZ":m.$("#login_logo").addClass("login-logo-ipptz"),a("#main_logo").addClass("main-logo-ipptz");break;default:m.$("#login_logo").addClass("login-logo-ipdome"),a("#main_logo").addClass("main-logo-ipdome")}!isEnable("is_show_LDAP")&&m.$("#login_type").remove(),m.render()},render:function(b){a("#main").hide(),m.element.css("top","50%").show(),"anonymity"!==i.get("username")&&m.$("#login_user").textfield("value",i.get("username")),m.$("#login_psw").textfield("value",""),(isDDNS()||webCaps.Anonymous)&&b!==!0?setTimeout(m.onLogin,100):m.$("#login_user").textfield("value")?m.$("#login_psw").focus():m.$("#login_user").focus(),document.title=tl("w_Login")},leave:function(){m.element.css("top","-100000").hide(),a("#main").show()},destory:function(){n.remove()},onLogin:function(b){var c=m.$("#login_user").textfield("value"),e=m.$("#login_psw").textfield("value"),f=m.$("#login_selType").val()||"Direct";if(!b)if(isDDNS()){var g=getDDNSMessage();c=g.username,e=g.password}else webCaps.Anonymous&&(c="anonymity",e="anonymity");l.login(c,e,f).done(function(){!l.needModifyPsw()||i.get("pwdNoTip")-0?d():(n.find(":password").val(""),n.find(".u-input-error").hide(),n.find(":checkbox").prop("checked",!1),n.find("li").removeClass("current"),n.find(".ui-pwd-strength").removeClass().addClass("ui-pwd-strength"),n.dialog("show"),n.find("[name=newpwd]").focus(),webApp.GongAnDetect&&(n.find("#no_tip").hide(),n.find("#u_close").hide(),n.find("#i_close").hide()))}).fail(function(b){switch(b){case 268632070:a.alert(tl("The user is not exited."));break;case 268632071:a.alert(tl("usernameOrPwdError"));break;case 268632073:a.alert(tl("The user is invalid."));break;case 268632074:a.alert(tl("The user has logined."));break;case 268632075:a.alert(tl("the number of connection is maximal.request is refused!"));break;case 268632081:a.alert(tl("The user is locked."));break;default:a.alert(tl("Login failure!"))}})},onCancel:function(){m.$("#login_user").textfield("value",""),m.$("#login_psw").textfield("value","")},onLogout:function(){webApp.IsSDIntel&&k.DevIntelliTracker.stop(),plugin.logout(),m.indexPage.leave(),m.indexPage.destory(),m.render(!0),l.logout()}}),a(window).on("unload",e)}),define("index_page",function(require,b,c){var d=require("/jsCore/pageBase"),e=(require("/jsCore/plugin"),webCaps.WebVersion?"?version="+webCaps.WebVersion:"");c.exports=d.extend({init:function(){var b=this,c=b.element.children(".u-tab"),d=b.element.children(".u-tab-content");b.tabs={},b.current=null,-1===webApp.DeviceType.indexOf("SD")&&login.chkAuthority("MPTZ")&&webApp.HasPtz&&!isEnable("is_8M_Flash")?ability.get("VideoInputCaps").always(function(a){a&&a.ElectricFocus?c.find("[data-for=ptz]").hide():c.find("[data-for=ptz]").show()}):c.find("[data-for=ptz]").hide(),login.chkAuthority("Replay_01")&&webApp.IsLocalStore&&!isEnable("is_8M_Flash")?c.find("[data-for=playback]").show():c.find("[data-for=playback]").hide(),a(document.body).css("background",'#373737 url("image/setbg.png") repeat-x'),c.tab({switched:function(a,f){var g=b.tabs[f.from],h=b.tabs[f.to];if(document.title=c.find("[data-for="+f.to+"] a").text(),g&&g.leave(),h)h.render(),b.current=h;else{var i=["/js/"+f.to+".js"+e];switch(f.to){case"logout":return webApp.loginPage.onLogout();case"playback":case"alarm":i.push("/html/"+f.to+".htm"+e);break;case"preview":case"ptz":case"set":}require.async(i,function(a,c){var e=d.find("[data-page="+f.to+"]");c?e.empty().append(c).translation():e.translation(),b.tabs[f.to]=new a({element:e}),b.current=b.tabs[f.to]})}}})},render:function(){this.current&&this.current.render()},leave:function(){this.current&&this.current.leave()},destory:function(){a.each(this.tabs,function(b,c){a.isFunction(c.destory)&&c.destory()}),this.current=null,this.tabs=null,this.element.children(".u-tab").tab("destroy")}})})}(jQuery);