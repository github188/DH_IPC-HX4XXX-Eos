!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab"),b.exports.prototype.aud_manage=ability.get("AudioFileManager").then(function(a){return!(!a||!a.Support)})}),define("aud_encode",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/pageBase"),f=require("jsCore/ability");require("widget/js/dui.slider");var g,h,i,j,k,l,m={},n=0,o=0;c.exports=e.extend({init:function(){g=this,g._getCaps().done(function(){g.render()})},render:function(a){d.ConfigManager.getConfig(["Encode","AudioInputVolume","AudioOutputVolume","AudioInDenoise","AudioInput"]).done(function(b){b[0].result&&(h=b[0].params.table),b[1].result&&(i=b[1].params.table),b[2].result&&(j=b[2].params.table),b[3].result&&(k=b[3].params.table),b[4].result&&(l=b[4].params.table),g._renderElements(),a&&g.tip("success","Operateingsuccess")}).fail(function(){g.tip("error","Operateingfailure")})},onSave:function(){var a=["Encode","AudioInputVolume","AudioOutputVolume","AudioInDenoise"],b=[h,i,j,k];g.propertySupport&&(a.push("AudioInput"),b.push(l)),g._saveElements(),d.ConfigManager.setConfig(a,b).done(function(){g.tip("success","Succeed in saving configure")}).fail(function(){g.tip("error","Saving failure")})},onRefresh:function(){g.render(!0)},onDefault:function(){d.ConfigManager.getDefault(["Encode","AudioInputVolume","AudioOutputVolume","AudioInDenoise","AudioInput"]).done(function(b){var c;b[0].result&&(c=b[0].params.table),b[1].result&&(i=b[1].params.table),b[2].result&&(j=b[2].params.table),b[3].result&&(k=b[3].params.table),b[4].result&&(l=b[4].params.table),a.each(h[n].MainFormat,function(a,b){b.Audio=c[n].MainFormat[a].Audio,b.AudioEnable=c[n].MainFormat[a].AudioEnable}),a.each(h[n].ExtraFormat,function(a,b){b.Audio=c[n].ExtraFormat[a].Audio,b.AudioEnable=c[n].ExtraFormat[a].AudioEnable}),g._renderElements(),g.tip("success","Defaultsuccess")}).fail(function(){g.tip("error","Operateingfailure")})},onFrequencyChange:function(a){var b=g.$(a.target).val(),c=g.$(a.target).attr("data-freq");g._renderFrequency(b,c)},onExStreamChange:function(a){var b=g.$(a.target).val()-0;g._saveExtraAudio(o),o=b,g._renderExtraAudio(b)},_getCaps:function(){var b,c,e,k,l;return k=f.get("AudioProperties").done(function(a){a&&a.Support?g.propertySupport=!0:g.$('[data-cap="AudioProperties"]').remove()}),webApp.AUDIO_IN_NUMBER?g.$("#au_vol_slider").slider({min:0,max:100,complete:function(b,c){a.each(i,function(a){i[a]=c.value})}}):g.$("#au_vol").remove(),webApp.AUDIO_OUT_NUMBER?g.$("#au_devol_slider").slider({min:0,max:100,complete:function(b,c){a.each(j,function(a){j[a]=c.value})}}):g.$("#au_devol").remove(),e=f.get("AudioInputCaps").done(function(a){var b=g.$("#au_source");for(var c in a)a[c]>0&&b.append('<option value="'+c+'" t="'+c+'"></option>');webApp.GongAnDetect&&b.append('<option value="立体声" t="立体声"></option>'),b.translation()}).fail(function(){g.$("#au_source").parent().remove()}),webApp.AUDIO_IN_NUMBER>1?(g.twoChannel=!0,g.$('[data-for="auIn0"]').remove(),g.$('[data-for="auInEx0"]').remove()):(g.$('[data-for="auIn1"]').remove(),g.$('[data-for="auInEx1"]').remove()),g._showRecordStream(),l=d.ConfigManager.getConfig("Encode").done(function(c){h=c,b=d.Encode.getConfigCaps(n,h).done(function(b){var c=g.$("#au_e_mList"),d=g.$("#au_extraAudioList"),e=b[0].MainFormat[0].Audio.CompressionTypes,f=[];null==b[0].ExtraFormat?g.$("#au_subStream_con").style.display="none":f=b[0].ExtraFormat[0].Audio.CompressionTypes,isEnable("is_show_PCM")||(e.erase("PCM"),f.erase("PCM")),c.empty(),d.empty(),a.each(e,function(a,b){c.append("<option value="+b+">"+b+"</option>")}),a.each(f,function(a,b){d.append("<option value="+b+">"+b+"</option>")})})}),c=d.DevAudioEncode.getFormatCaps(n).done(function(b){a.each(b,function(b,c){void 0==m[c.Compression]&&(m[c.Compression]=[]),-1==a.inArray(c.Frequency,m[c.Compression])&&m[c.Compression].push(c.Frequency)})}),a.Deferred(function(c){a.when(k,l,e).done(function(){b.done(function(){c.resolve()})})})},_showRecordStream:function(){f.is("ExtraConflict").done(function(a){webApp.MaxExtraStream<2?g.$("#au_extraStreams").hide():g.$("#au_extraStreams").show(),g.$("#au_extraStreams").empty();for(var b=a?1:webApp.MaxExtraStream,c=0;b>c;c++)g.$("#au_extraStreams").append("<option value="+c+' t="w_SecondStream+'+(c+1)+'">'+tl("w_SecondStream"+(c+1))+"</option>")})},_renderFrequency:function(a,b){var c,d=g.$("#"+b);d.empty();for(var e=0;e<m[a].length;e++)d.append("<option value="+m[a][e]+">"+m[a][e]/1e3+"k</option>");switch(b){case"au_FreM":c=h[0].MainFormat[0].Audio.Frequency;break;case"au_FreE":var f=parseInt(g.$("#au_extraStreams").val())||0;c=h[0].ExtraFormat[f].Audio.Frequency}d.val(-1!==m[a].indexOf(c)?c:m[a][0])},_renderElements:function(){var b=h[n].MainFormat[0];g.twoChannel?(g.$("#au_e_mCh0").prop("checked",b.AudioEnable&&-1!==a.inArray(0,b.Audio.Channels)),g.$("#au_e_mCh1").prop("checked",b.AudioEnable&&-1!==a.inArray(1,b.Audio.Channels))):g.$("#au_e_mEnable").prop("checked",b.AudioEnable),g.$("#au_e_mList").val(b.Audio.Compression).change();var c=parseInt(g.$("#au_extraStreams").val())||0;g._renderExtraAudio(c),1==g.propertySupport&&g.$("#au_source").val(l[0].AudioSource),g.$("#au_InDenoise").val(k[0].enable?1:0),webApp.AUDIO_IN_NUMBER&&g.$("#au_vol_slider").slider("value",i[0]),webApp.AUDIO_OUT_NUMBER&&g.$("#au_devol_slider").slider("value",j[0])},_renderExtraAudio:function(b){var c=g.$("#au_e_eEnable"),d=g.$("#au_e_eCh0"),e=g.$("#au_e_eCh1"),f=h[n].ExtraFormat[b];g.twoChannel?(d.prop("checked",f.AudioEnable&&-1!==a.inArray(0,f.Audio.Channels)),e.prop("checked",f.AudioEnable&&-1!==a.inArray(1,f.Audio.Channels))):c.prop("checked",h[n].ExtraFormat[b].AudioEnable),h[n].ExtraFormat[b].VideoEnable?(g.disabled(d,!1),g.disabled(e,!1),g.disabled(c,!1)):(g.disabled(d,!0),g.disabled(e,!0),g.disabled(c,!0),d.prop("checked",!1),e.prop("checked",!1),c.prop("checked",!1)),g.$("#au_extraAudioList").val(h[n].ExtraFormat[b].Audio.Compression).change()},_saveElements:function(){var b=h[n].MainFormat;if(g.twoChannel){var c=g.$("#au_e_mCh0").prop("checked"),d=g.$("#au_e_mCh1").prop("checked"),e=[];c&&e.push(0),d&&e.push(1);var f=c||d}else var i=g.$("#au_e_mEnable").prop("checked");var j=g.$("#au_e_mList").val();a.each(b,function(a){g.twoChannel?(b[a].Audio.Channels=e,b[a].AudioEnable=f):b[a].AudioEnable=i,b[a].Audio.Compression=j,b[a].Audio.Frequency=g.$("#au_FreM").val()-0});var m=parseInt(g.$("#au_extraStreams").val())||0;g._saveExtraAudio(m),l[0].AudioSource=g.$("#au_source").val(),1==g.propertySupport&&a.each(k,function(a,b){b.enable=!(1!=g.$("#au_InDenoise").val())})},_saveExtraAudio:function(a){var b=h[n].ExtraFormat[a];if(b.Audio.Compression=g.$("#au_extraAudioList").val(),b.Audio.Frequency=g.$("#au_FreE").val()-0,g.twoChannel){var c=g.$("#au_e_eCh0").prop("checked"),d=g.$("#au_e_eCh1").prop("checked");b.Audio.Channels=[],c?b.Audio.Channels.push(0):!1,d?b.Audio.Channels.push(1):!1,b.AudioEnable=c||d}else b.AudioEnable=g.$("#au_e_eEnable").prop("checked")},leave:function(){}})}),define("aud_manage",function(require,b,c){var d,e,f,g,h,i,j=require("jsCore/rpc"),k=require("jsCore/pageBase"),l={};c.exports=k.extend({init:function(){d=this,h=d.$("#aud_diaAdd").dialog({switcher1:function(){d.$("div[data-show]").hide(),h.find("div[data-show=record]").show()},switcher2:function(){d.$("div[data-show]").hide(),h.find("div[data-show=upload]").show()},record:function(){d._recordAu()},stopRecord:function(){d._recordAuStop()},upload:function(){d._uploadAu()}}).detach().appendTo(document.body),i=d.$("#aud_diaEdit").dialog({confirm:function(){d._saveAudioModify()}}).detach().appendTo(document.body),h.dialog("setPosition",[200,600]),i.dialog("setPosition",[200,600]),d.table=d.$(".u-table").table({height:220,columns:[{title:tl("w_chooseAudio"),width:"10%",render:function(a){var b='<input type="radio"';return a.choosed&&(b+=' checked="checked"'),b+=">"}},{title:tl("w_Name"),render:function(a){var b=a.path.split("/").pop();return b}},{title:tl("w_play"),action:"play",icon:"i-play",handle:function(a){j.Speak.startPlay(a.path).done(function(){d.tip("success","w_playAudioSuccess")}).fail(function(){d.tip("error","w_playAudioFailed")})}},{title:tl("w_Download"),action:"down",icon:"i-down",render:function(a){var b='<a href="'+a.path+'" target="_blank"><i data-action="down" class="i-down"></i></a>';return b}},{title:tl("w_Amend"),action:"edit",icon:"i-edit",handle:function(){i.dialog("show")}},{title:tl("w_Delete"),action:"delete",icon:"i-del",handle:function(a){var b=a.path;j.FileManager.removeFiles(b).done(function(){d.render(),d.tip("success","w_Delsuccess")}).fail(function(){d.tip("error","w_Delfail")})}}],onRowSelect:function(a,b){d.$(".u-table input").prop("checked",!1),d.$(".u-table input:eq("+b.rowIndex+")").prop("checked",!0);var c=b.rowIndex;return d._audioPlayCheck(c),!1}}),d.bind(),ability.get("AudioFileManager").done(function(b){d.audio_url=b?b.PlayRootPath.split(";")[1]:"",j.FileManager.list(b?b.PlayRootPath.split(";")[0]:"").done(function(b){e=[],a.each(b,function(a,c){"File"===b[a].type&&(c.file["default"]=!0,e.push(c.file))}),d.render()})})},bind:function(){h.find("#au_scan").click(function(){h.find("#au_dahuaupload").click(),this.blur()}),h.find("#au_dahuaupload").bind({change:function(){d._changePath(this)},blur:function(){d._changePath(this)}})},onAddAudio:function(){h.dialog("show")},render:function(){j.FileManager.list(d.audio_url).always(function(b){f=[],j.ConfigManager.getConfig("Sound").done(function(a){g=a}).always(function(){a.each(b,function(a,c){c.file.choosed=g&&g.AlarmSound==c.file.path.split("/").pop()?!0:!1,"File"===b[a].type&&f.push(c.file)}),f.concat(e),d.table.table("dataSource",f)})})},destory:function(){h.remove(),i.remove()},_saveAudioModify:function(){var a=i.find("#au_modifyName").val();if(0==a.trim().length)return void d.tip("error","w_filename_not_null");var b=d.$(".u-table .current td:eq(2)").text(),c=d.audio_url+a+"."+b.split(".").pop(),e=a+"."+b.split(".").pop();return d._isNameRepeat(e)?void d.tip("error","w_noSameName"):void j.FileManager.rename(b,c).done(function(){d.$(".u-table .current td:eq(1)").html(a+"."+b.split(".").pop()),d.$(".u-table .current td:eq(1)").attr("title",a+"."+b.split(".").pop()),d.$(".u-table .current td:eq(1)").attr("file-name",a+"."+b.split(".").pop()),d.$(".u-table .current td:eq(2)").html(c),d.$(".u-table .current td:eq(2)").attr("file-name",c),d.$(".u-table .current td a:eq(0)").attr("href",d.audio_url+encodeURIComponent(a)+"."+b.split(".").pop()),d.$(".u-table .current td input:eq(0)").prop("checked")&&d._audioPlayCheck(audio_modifyNum,0,1),i.dialog("close"),d.tip("success","w_modifySuccessed")}).fail(function(a){409==a.error.code?d.tip("error","w_noSameName"):404==a.error.code?d.tip("error","w_modifyFailed"):d.tip("error","w_modifyFailed")})},_changePath:function(a){var b=a.value,c=b.lastIndexOf("\\");c>=0&&(b=b.slice(c+1)),h.find("#au_path").val(b)},_uploadAu:function(){var a=h.find("#au_path").val();if(0==a.length)return void d.tip("error","w_chooseFile");var b=a.split(".").getLast();return"pcm"!==b&&"wav"!==b?void d.tip("error","w_audioFormat"):void clickElement(h.find("#au_submit")[0])},_recordAu:function(){var a=h.find("#au_recordeName").val();if(0==a.trim().length)return void d.tip("error","w_filename_not_null");var b="Main",c=h.find("#au_recordeName").val().trim()+".pcm",e=d.audio_url+c;return d._isNameRepeat(c)?void d.tip("error","w_noSameName"):void j.AudioRecordManager.startChannel(b,e).done(function(){d.disabled("#audio_recordeName",!0),d.disabled("#audio_optionsUpload",!0),h.find("[data-action=record]").hide(),h.find("[data-action=stopRecord]").show(),d._audioRecordStatus.delay(500)}).fail(function(a){a.error&&506==a.error.code?d.tip("error","w_fileNumLimit"):d.tip("error","w_RecordeFail")})},_recordAuStop:function(){var a=d.audio_url+h.find("#au_recordeName").val().trim()+".pcm";j.AudioRecordManager.stopChannel("Main",a).done(function(){d.disabled("#audio_recordeName",!1),d.disabled("#audio_optionsUpload",!1),h.find("[data-action=record]").show(),h.find("[data-action=stopRecord]").hide(),d.tip("success","w_RecordeSuccess")}).fail(function(){d.tip("error","w_RecordeFail")})},_audioRecordStatus:function(){j.AudioRecordManager.getStateAll().done(function(a){a[0].Main.State?d._audioRecordStatus.delay(500):(d.disabled("#audio_recordeName",!1),d.disabled("#audio_optionsUpload",!1),h.find("[data-action=record]").show(),h.find("[data-action=stopRecord]").hide(),d.render(),d.tip("success","w_RecordeSuccess"))}).fail(function(){h.find("[data-action=record]").show(),h.find("[data-action=stopRecord]").hide(),h.dialog("close"),d.tip("error","w_RecordeFail")})},_audioDelInfo:function(a){d.$("#audio_devList_"+a+" td input:eq(0)").prop("checked")&&d._audioPlayCheck(a,1);var b=d.$("#audio_devList_"+a+" td:eq(2)").attr("file-name");j.FileManager.removeFiles(b).done(function(){l._audioGetAll(),remarkDisplay("audio_fileRemark",tl("w_Delsuccess"),3e3,0)}).fail(function(){remarkDisplay("audio_fileRemark",tl("w_Delfail"),3e3,1)})},_audioPlayCheck:function(a,b,c){g.AlarmSound=b?d.$("#audio_devList_"+audioDefaultList[0]+" td:eq(2)").attr("text"):d.$("#audio_devList_"+a+" td:eq(2)").attr("text"),j.ConfigManager.setConfig("Sound",g).done(function(){b||c||remarkDisplay("audio_fileRemark",tl("w_audioAlarmSuccess"),3e3,0)}).fail(function(){remarkDisplay("audio_fileRemark",tl("w_audioAlarmFailed"),3e3,1)})},_isNameRepeat:function(a){var b=f.some(function(b){var c=b.path.split("/").pop();return a===c});return b},leave:function(){}}),window.audioUploadStatue=function(a){switch(a){case 1:d.tip("success","w_uploadSuccess");break;case 400:d.tip("error","w_RequestError");break;case 401:d.tip("error","w_WithoutPermission");break;case 409:d.tip("error","w_FileExist");break;case 413:d.tip("error","w_LowSpace");break;case 415:d.tip("error","w_property_failed");break;case 506:d.tip("error","w_fileNumLimit");break;case 507:d.tip("error","w_fileSizeLimit");break;default:d.tip("error","w_uploadFail")}h.dialog("close"),d.render()}})}(jQuery);