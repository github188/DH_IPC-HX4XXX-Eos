!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab")}),define("calibrate",function(require,b,c){var d,e,f=require("jsCore/rpc"),g=require("jsCore/plugin"),h=require("jsCore/rpcLogin"),i=require("jsCore/pageBase"),j=null,k=null,l=!0,m=!1,n=[{PointPair:[{id:0,VisalPoint:[100,400],ThermPoint:[200,400]},{id:1,VisalPoint:[600,600],ThermPoint:[1800,800]}]},{PointPair:[{id:2,VisalPoint:[800,800],ThermPoint:[1500,400]},{id:3,VisalPoint:[1e3,4e3],ThermPoint:[2e3,4e3]}]}];c.exports=i.extend({init:function(){j=this,g.CheckFuncSupport(2).done(function(b){b?a("#cal_a_fullscreen").show():a("#cal_a_fullscreen").hide()}),j._initPtz(),j._initCalibration(),j.render()},_initPtz:function(){-1===webApp.DeviceType.indexOf("SD")?(j.$("#cal_boat").remove(),j.$("#cal_zf").remove()):(-1!==webApp.DeviceType.indexOf("SD_CA_ICT")?(j.$("#cal_boat").remove(),j.$("#cal_zf").addClass("fn-marl130")):j.$("#cal_boat").show().find("div[command]").mousedown(function(a){var b=j.$(a.target).addClass("mouse-down");return f.PTZ.start(b.attr("command"),j.$("#cal_footStep").val()-0,0,0),!1}).mouseup(function(a){var b=j.$(a.target).removeClass("mouse-down");return f.PTZ.stop(b.attr("command"),j.$("#cal_footStep").val()-0,0,0),!1}).mouseover(function(a){var b=j.$(a.target);return b.parent().addClass("ui-boat-current-"+b.attr("command").toLowerCase()),!1}).mouseout(function(a){var b=j.$(a.target),c=b.attr("command");return b.parent().removeClass("ui-boat-current-"+c.toLowerCase()),b.hasClass("mouse-down")?(b.removeClass("mouse-down"),f.PTZ.stop(c,j.$("#cal_footStep").val()-0,0,0),!1):!1}),j.$("#cal_zf").show().find("a[command]").mousedown(function(a){var b=j.$(a.currentTarget).addClass("mouse-down");return f.PTZ.start(b.attr("command"),j.$("#cal_footStep").val()-0||5,0,0,0),("ZoomWide"===b.attr("command")||"ZoomTele"===b.attr("command"))&&(m=!0),!1}).mouseup(function(a){var b=j.$(a.currentTarget).removeClass("mouse-down");return f.PTZ.stop(b.attr("command"),j.$("#cal_footStep").val()-0||5,0,0,0),!1}).mouseout(function(a){var b=j.$(a.currentTarget);return b.hasClass("mouse-down")?(b.removeClass("mouse-down"),f.PTZ.stop(b.attr("command"),j.$("#cal_footStep").val()-0||5,0,0,0),!1):!1}))},_initCalibration:function(){j.$("#cal_a_fullscreen").find("a[btn-for]").click(function(a){var b=j.$(a.target),c=b.attr("btn-for")-0;2>c&&(m=!1);for(var f=0;4>f;f++){var h=j.$("#cal_a_fullscreen a").get(f),i=j.$(h);if(i.hasClass("ui-button-hover")&&f!=c)return j.$("#cal_tip").tip("error",tl("PleaseCalibrationOneFinishThenAnother")),!1;if(!b.hasClass("ui-button-current")&&!i.hasClass("ui-button-current")&&c>f)return j.$("#cal_tip").tip("error",tl("PleaseCalibrationBefore")),!1}e=c;var n=e>1?1:0;if(d=k[n].PointPair[e-2*n],l=!0,b.hasClass("ui-button-current"))g.SetCalibrationEnable(e,!1).done(function(){b.removeClass("ui-button-current"),d.VisalPoint[0]=0,d.VisalPoint[1]=0,d.ThermPoint[0]=0,d.ThermPoint[1]=0,j._render()});else{if(e>1&&!m)return j.$("#cal_tip").tip("error",tl("PleaseChangeZoomFirst")),!1;g.SetCalibrationEnable(e,!0).done(function(){b.addClass("ui-button-hover"),j.$("#cal_tip").tip("success",tl("PleaseCalibrationCenter"))})}})},render:function(){g.SetIVSDrawingEnable(!1),g.cover("#cal_video",function(){if(h.chkAuthority("Monitor_01")&&h.chkAuthority("Monitor_02")){var a=j.$("#cal_a_fullscreen").width();j.$("#cal_video").width(a),g.SetVisibleVideoWnd(2,0),g.ConnectAllChannel(2,1),setTimeout(function(){j._getConfig(!1)},2500)}}),g.addEvent("CalibrationData",function(a){var b=JSON.decode(a),c=b.WndID;l=!l,c?d.ThermPoint=b.ThermPoint[0]:d.VisalPoint=b.VisalPoint[0],l&&j.$(j.$("#cal_a_fullscreen a").get(e)).removeClass("ui-button-hover").addClass("ui-button-current")})},leave:function(){g.hide(),g.ClearAllOpData()},_render:function(){k.each(function(a,b){a.PointPair.each(function(a,c){if(a.VisalPoint[0]>0&&a.VisalPoint[1]>0&&a.ThermPoint[0]>0&&a.ThermPoint[1]>0){var d=j.$(j.$("#cal_a_fullscreen a").get(2*b+c));d.hasClass("ui-button-hover")&&d.removeClass("ui-button-hover"),d.addClass("ui-button-current")}n[b].PointPair[c].VisalPoint[0]=a.VisalPoint[0],n[b].PointPair[c].VisalPoint[1]=a.VisalPoint[1],n[b].PointPair[c].ThermPoint[0]=a.ThermPoint[0],n[b].PointPair[c].ThermPoint[1]=a.ThermPoint[1]})}),g.SetCalibrationData(JSON.encode(n))},onDefault:function(){return f.ConfigManager.getDefault("CalibratePoints").done(function(a){k=a,l=!0,j._render(),j.$("#cal_tip").tip("success",tl("Defaultsuccess"))}).fail(function(){j.$("#cal_tip").tip("error",tl("Defaultfailure"))}),!1},onRefresh:function(){return j._getConfig(!0),!1},onSave:function(){if(!l)return j.$("#cal_tip").tip("error",tl("PleaseCalibrationOneFinishThenAnother")),!1;var a=j.$("#cal_a_fullscreen").find(".ui-button-current").length;return 4>a?(j.$("#cal_tip").tip("error",tl("PleaseCalibrationAll")),!1):(f.ConfigManager.setConfig("CalibratePoints",k).done(function(){j.$("#cal_tip").tip("success",tl("Succeed in saving configure"))}).fail(function(){j.$("#cal_tip").tip("error",tl("Saving failure"))}),!1)},_getConfig:function(a){f.ConfigManager.getConfig("CalibratePoints").done(function(b){k=b,l=!0,j._render(),a&&j.$("#cal_tip").tip("success",tl("Operateingsuccess"))}).fail(function(){j.$("#cal_tip").tip("error",tl("Operateingfailure"))})}})})}(jQuery);