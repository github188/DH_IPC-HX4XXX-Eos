!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab")}),define("ipc_face",function(require,b,c){function d(a){for(var b=0;b<a.length;b++)if(0!==a[b])return!1;return!0}var e=require("jsCore/rpc"),f=require("jsCore/pageBase"),g=require("jsCore/plugin"),h=require("jsCore/ability"),i=require("jsCore/modules/timeSection"),j=require("jsCore/modules/IntellMutex"),k=require("common/common");require("widget/js/dui.slider"),require("jsCore/modules/eventHandler");var l=null,m=null,n=null,o=null,p=null,q=null,r=!1,s=!0;c.exports=f.extend({init:function(){l=this,m=new j("i_f_mutex"),l.$("#i_f_event").eventHandler(),l.$("#i_f_alacount").numberfield({min:1,max:35,allowDecimal:!1,allowNegative:!1}),l.$("#i_f_t_value").numberfield({min:0,max:100,allowDecimal:!1,allowNegative:!1}),h.get("VideoInputCapsEx").done(function(a){a&&a.FaceAutoExposure&&a.FaceAutoExposure.Support&&(r=!0,l.$("#i_f_expo").show(),l.$("#i_f_expo_light, #i_f_expo_time").slider({min:0,max:100}),l.$("#i_f_expo_enable").on("click",function(){l.$(this).prop("checked")&&!l.$("#i_f_enable").prop("checked")&&l.$("#i_f_tip").tip("warning",tl("isEnableFacetect"))}),l.$("#i_f_enable").on("click",function(){!l.$(this).prop("checked")&&l.$("#i_f_expo_enable").prop("checked")&&l.$("#i_f_tip").tip("warning",tl("isDisableFacetect"))}))}),e.DevVideoEncode.getCaps().done(function(a){a&&a.DynamicTrackROI&&l.$("#i_f_enhance").prop("disabled",!1)}),h.get("IVSCaps").done(function(a){if(webCaps.is_new_IVSUI!==!0){var b=j.getIntellMutexTip("FaceDetection",a||{});b&&(m.add("intell",b),m.setCtrl("intell",!0)),m.add("tvout",'<span t="IntellMutexTVOut">'+tl("IntellMutexTVOut")+"</span>")}l.render()}),-1!==webApp.DeviceType.indexOf("SD")&&(s=!1,l.$("#i_f_target").parent().hide().prev().hide()),l.$("#i_f_enable").on("click",function(){n.Enable=this.checked,this.checked?m.show():m.hide(),g.SetIVSConfig("",1),l._initTarget()}),l.$("#i_f_max").on("click",function(){l.$(this).prop("checked",!0),l._targetRule()}),l.$("#i_f_min").on("click",function(){l.$(this).prop("checked",!0),l._targetRule()}),-1!=webApp.DeviceType.indexOf("TPC")&&webApp.DeviceType.indexOf("-T")&&l.$("js_tpc_t").removeClass("fn-hide")},render:function(){webCaps.is_new_IVSUI!==!0&&m.setCtrl("tvout",g_videoInConflict.DSP.hasConflict()),g.cover("#i_f_video",function(){g.SetRegionNum(0),g.SetModuleMode(2),login.chkAuthority("Monitor_01")&&g.open()}),g.addEvent("OutPutStringInfo",function(a,b){if("OutPutObjectRect"===a){var c=JSON.parse(b);c.MinRect?n.Config.SizeFilter.MinSize=c.MinRect:c.MaxRect&&(n.Config.SizeFilter.MaxSize=c.MaxRect),l._renderSizeFilter(n.Config.SizeFilter,!0),l.$("#i_f_max, #i_f_min").prop("disabled",!1)}}),l._getConfig(!1)},leave:function(){g.addEvent("OutPutStringInfo",null),g.hide(),g.close()},_getConfig:function(a){var b=["VideoAnalyseRule","VideoEncodeROI"];-1!=webApp.DeviceType.indexOf("TPC")&&-1!==webApp.DeviceType.indexOf("-T")&&b.push("FaceRadiometry"),r&&b.push("VideoInFaceAutoExposure"),e.ConfigManager.getConfig(b).done(function(b){k.chkMutilCallRet(b)?(l._renderElements(b),a&&l.$("#i_f_tip").tip("success",tl("Operateingsuccess"))):l.$("#i_f_tip").tip("error",tl("Operateingfailure"))})},_renderElements:function(b,c){var d=b[0].params.table;a.each(d[analyseSenceRuleMap.FaceDetection],function(a,b){return"FaceDetection"===b.Type?(n=b,!1):void 0}),n.Config.SizeFilter||(n.Config.SizeFilter={},n.Config.SizeFilter.MaxSize=[8191,8191],n.Config.SizeFilter.MinSize=[500,500]),l.$("#i_f_enable").prop("checked",n.Enable),l.$("#i_f_alacount").numberfield("value",n.Config.TriggerTargets||1),l.$("#i_f_event").eventHandler("set",n.EventHandler),l._renderSizeFilter(n.Config.SizeFilter),c!==!1&&(p=b[1].params.table,l.$("#i_f_enhance").prop("checked",p[0].DynamicTrack)),q&&(q=b[2].params.table,l.$("#i_f_t_enable").prop("checked",q[0].Enable),l.$("#i_f_t_value").numberfield("value",q[0].threshold||0)),r&&(o=b[b.length-1].params.table,l.$("#i_f_expo_enable").prop("checked",o[0].Enable),l.$("#i_f_expo_light").slider("value",o[0].TargetBrightness),l.$("#i_f_expo_time").slider("value",o[0].Interval))},_renderSizeFilter:function(b,c){s&&(!c&&l._initTarget(),a.each(l.$("#i_f_target").find("input[type=text]"),function(a,c){var d=c.name.split("-");l.$(this).val(b[d[0]][parseInt(d[1])])}))},onDrawTarget:function(){return l.$("#i_f_enable").prop("checked")?l.$("#i_f_max").prop("disabled")?void l.$("#i_f_tip").tip("error",tl("Please draw shape")):void l._targetRule():void 0},clearTarget:function(){if(l.$("#i_f_enable").prop("checked")&&n&&n.Config.SizeFilter){if(l.$("#i_f_max").prop("disabled"))return void l.$("#i_f_tip").tip("error",tl("Please draw shape"));l.$("#i_f_max").prop("checked")?(g.DeleteShape("MaxRect"),g.AddShape(5,"","MaxRect",0,-1)):(g.DeleteShape("MinRect"),g.AddShape(5,"","MinRect",0,-1)),l.$("#i_f_max, #i_f_min").prop("disabled",!0)}},_initTarget:function(){if(g.SetIVSConfig("",1),l.$("#i_f_enable").prop("checked")&&n&&n.Config.SizeFilter){var a={};a.MaxRect=n.Config.SizeFilter.MaxSize,a.MinRect=n.Config.SizeFilter.MinSize,g.SetObjectConfig(JSON.stringify(a)),g.SetCurPtzID(0)}},_targetRule:function(){l.$("#i_f_enable").prop("checked")&&n&&n.Config.SizeFilter&&(l.$("#i_f_max").prop("checked")?d(n.Config.SizeFilter.MaxSize)?g.AddShape(5,"","MaxRect",0,-1):g.SetCurShape("MaxRect"):d(n.Config.SizeFilter.MinSize)?g.AddShape(5,"","MinRect",0,-1):g.SetCurShape("MinRect"))},onDefault:function(){var a=["VideoAnalyseRule"];r&&a.push("VideoInFaceAutoExposure"),e.ConfigManager.getDefault(a).done(function(a){k.chkMutilCallRet(a)?(l._renderElements(a,!1),l.$("#i_f_tip").tip("success",tl("Defaultsuccess"))):l.$("#i_f_tip").tip("error",tl("Defaultfailure"))})},onRefresh:function(){l._getConfig(!0)},onConfirm:function(){if(l.$("#i_f_max").prop("disabled"))return void l.$("#i_f_tip").tip("error",tl("Please draw shape"));var b=["VideoAnalyseRule","VideoEncodeROI"],c=[n,p];g.SetCurShape("save"),n.Enable=l.$("#i_f_enable").prop("checked"),n.Config.TriggerTargets=l.$("#i_f_alacount").numberfield("value"),n.EventHandler=l.$("#i_f_event").eventHandler("get"),p[0].DynamicTrack=l.$("#i_f_enhance").prop("checked"),q&&(q[0].Enable=l.$("#i_f_t_enable").prop("checked"),q[0].threshold=l.$("#i_f_t_value").numberfield("value"),b.push("FaceRadiometry"),c.push(q)),r&&(o[0].Enable=l.$("#i_f_expo_enable").prop("checked"),o[0].TargetBrightness=l.$("#i_f_expo_light").slider("value"),o[0].Interval=l.$("#i_f_expo_time").slider("value"),b.push("VideoInFaceAutoExposure"),c.push(o)),e.ConfigManager.getConfig("VideoAnalyseRule").done(function(d){a.each(d[analyseSenceRuleMap.FaceDetection],function(a,f){return"FaceDetection"===f.Type?(d[analyseSenceRuleMap.FaceDetection][a]=n,c[0]=d,e.ConfigManager.setConfig(b,c).done(function(a){k.chkMutilCallRet(a)?l.$("#i_f_tip").tip("success",tl("Succeed in saving configure")):l.$("#i_f_tip").tip("error",tl("Saving failure"))}),!1):void 0})}).fail(function(){l.$("#i_f_tip").tip("error",tl("Saving failure"))})},onSetPeriod:function(){n&&n.EventHandler&&n.EventHandler.TimeSection&&(g.hide(),i.open(n.EventHandler.TimeSection).done(function(a){n.EventHandler.TimeSection=a}).always(function(){g.cover("#i_f_video")}))}})})}(jQuery);