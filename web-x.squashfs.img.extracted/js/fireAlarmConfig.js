!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab")}),define("fireWarn",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/ability"),f=require("jsCore/plugin"),g=require("jsCore/rpcLogin"),h=require("jsCore/PageBase"),i=require("jsCore/modules/timeSection");require("jsCore/modules/ptzPreset"),require("jsCore/modules/eventHandler"),require("widget/js/dui.slider"),require("widget/js/dui.iconlist"),require("widget/js/dui.iconSelect");var j=null,k=0,l=null,m=webApp.CHANNEL_NUMBER>1?1:0,n=null;c.exports=h.extend({init:function(){j=this,e.get("IVSCaps").done(function(a){m&&a&&a.SupportedRules&&a.SupportedRules.contains("SmokeDetection")||(j.$("[sel-for=onSelChannel] option:first").remove(),j.$(".u-tab").find("[data-for=visible]").remove(),j.$(".u-tab-content").find("[data-page=visible]").remove())}),webApp.CHANNEL_NUMBER>1&&(j.$("#fir_channel").parent().removeClass("fn-hide"),n=a("#fir_channel").iconSelect({channelNumber:webApp.CHANNEL_NUMBER,allEnable:!1,change:function(b,c){a("#f_w_tab").children("li").eq(c.ch).trigger("click")}}),n.iconSelect("index",k)),j._initTab(),j.render()},render:function(){f.SetIVSDrawingEnable(!1)},_initTab:function(){var a=j.$(".u-tab"),b=j.$(".u-tab-content");j.tabs={},a.tab({switched:function(a,c){var d=j.tabs[c.from],e=j.tabs[c.to];d&&d.leave(),e?(e.render(),j.current=e):require.async(c.to,function(a){j.tabs[c.to]=new a({element:b.find("[data-page="+c.to+"]")}),j.current=j.tabs[c.to]})}})},onSelChannel:function(){a(event.target).val()-0==0?(k=0,j.$("#f_w_tab").tab("select","visible")):(k=m,j.$("#f_w_tab").tab("select","thermal"))},leave:function(){j.$(".u-tab").children("li.current").data("tabInstance").leave()},destory:function(){j.$(".u-tab").children().each(function(a,b){j.$(b).data("tabInstance").destory()})}}),define("visible",function(require,b,c){var e,j,m,n,o=null,p=null,q=null,r=null,s=[];c.exports=h.extend({init:function(){o=this,o.bind(),o.$("#f_w_presetConV").ptzPreset(k).ptzPreset("change",o._saveElements,o._filterRule,k),o.$("#f_w_event").eventHandler(),o._getDefault(),d.ConfigManager.getConfig("VideoAnalyseModule").done(function(a){n=a[0][0].SizeFilter})},bind:function(){o.$("[slider][key=SensitivityV]").slider({min:0,max:10,complete:function(a,b){j&&(j.Config.Sensitivity=b.value)}}),o.$("#f_w_max").click(function(){o.$("#f_w_min").prop("checked",!1),f.SelectOneIntelShape(s[1],!0),f.SelectOneIntelShape(s[0],!1)}),o.$("#f_w_min").click(function(){o.$("#f_w_max").prop("checked",!1),f.SelectOneIntelShape(s[1],!1),f.SelectOneIntelShape(s[0],!0)}),f.addEvent("VideoAnalyzeConfig",function(a){var b=JSON.decode(a),c=b.EventParam.ShapeID;if("Polygon"==c)b.ShapeData.DetectLine.length<3,j.Config.DetectRegion=b.ShapeData.DetectLine;else if("BigFilter"==c){var d=b.ShapeData.RectangleShape,e=Math.abs(parseInt(d[1][0]-d[0][0])),g=Math.abs(parseInt(d[1][1]-d[0][1]));j.Config.SizeFilter.MaxSize=[e,g],o._renderSizeFilter(j.Config.SizeFilter)}else if("SmallFilter"==c){var d=b.ShapeData.RectangleShape,e=d[1][0]-d[0][0],g=d[1][1]-d[0][1];j.Config.SizeFilter.MinSize=[e,g],o._renderSizeFilter(j.Config.SizeFilter)}f.SelectOneIntelShape(c,!0)})},render:function(){f.cover("#f_w_videoV",function(){var a="Monitor_0"+(k+1);g.chkAuthority(a)?(f.SetVisibleVideoWnd(1,k),f.ConnectRealVideoEx(k,k,0)):(f.SetVisibleVideoWnd(1,k),f.SetVideoWndTip(k,tl("noVideoAuthoity")))}),o.$("#f_w_minDuration").numberfield({min:1,max:600,allowNegative:!1,allowDecimal:!1}),d.ConfigManager.getConfig("VideoAnalyseRule").done(function(a){e=a,o._filterRule()})},leave:function(){p&&f.DeleteAllIntelShape(p),f.hide()},onSetPeriod:function(){f.hide(),j&&j.EventHandler&&j.EventHandler.TimeSection&&i.open(j.EventHandler.TimeSection).done(function(a){j.EventHandler.TimeSection=a}).always(function(){f.cover("#f_w_videoV")})},onDraw:function(){j&&(p&&q?(r&&f.SetOneIntelShapeVisible(r,!1),f.SetOneIntelShapeVisible(q,!0),f.SelectOneIntelShape(q,!0)):o._DrawNewRule())},_DrawNewRule:function(){r=null,q=null,s=[],p?o._CreateShape(p):f.CreateOneIntelShapeContainer(k,"").done(function(a){p=a,o._CreateShape(p)})},_CreateShape:function(a,b){b=b||"",f.CreateOneIntelShape(a,"Polygon","VideoAnalyzeConfig","Polygon","",b,"").done(function(a){q=a,f.SetOneIntelShapeDisplayColor(q,0,255,255,0),f.SetOneIntelShapeDisplayColor(q,1,0,0,255),f.SetOneIntelShapeThickness(q,2),f.SetOneIntelShapeVisible(q,!0),f.SelectOneIntelShape(q,!0)})},onClean:function(){j&&p&&q&&(f.DeleteOneIntelShape(q),q=null,r&&(f.DeleteOneIntelShape(r),r=null))},onDrawTarget:function(){j&&(f.SetOneIntelShapeVisible(q,!1),s[0]&&s[1]?f.SetOneIntelShapeVisible(r,!0):s[0]&&null==s[1]?o._CreateFilter(!0):null==s[0]&&s[1]?o._CreateFilter(!1):(r&&f.DeleteOneIntelShape(r),f.CreateOneIntelShape(p,"BigSmallFilterBox","VideoAnalyzeConfig","BigSmallFilterBox","","","").done(function(b){r=b,s=[],a.when(o._CreateFilter(!1)).done(function(){o._CreateFilter(!0)})})),f.SelectOneIntelShape(s[1],o.$("#f_w_max").prop("checked")),f.SelectOneIntelShape(s[0],!o.$("#f_w_max").prop("checked")))},_CreateFilter:function(a){var b,c,d,e,g=a?"BigFilter":"SmallFilter";j.Config.SizeFilter?b=a?j.Config.SizeFilter.MaxSize:j.Config.SizeFilter.MinSize:(b=a?n.MaxSize:n.MinSize,j.Config.SizeFilter={},j.Config.SizeFilter.MinSize=n.MinSize,j.Config.SizeFilter.MaxSize=n.MaxSize),c=[[(8191-b[0])/2,(8191-b[1])/2],[(8191+b[0])/2,(8191+b[1])/2]],d={RectangleShape:c},d=JSON.encode(d),f.AddOneSubIntelShape(p,r,"RectangleShape","VideoAnalyzeConfig",g,"",d,"").done(function(b){e=b,f.SetOneIntelShapeDisplayColor(e,0,0,255,255),f.SetOneIntelShapeDisplayColor(e,1,0,255,255),f.SetOneIntelShapeThickness(e,a?2:1),a?s[1]=e:s[0]=e})},onCleanTarget:function(){j&&0!=s.length&&(o.$("#f_w_max").prop("checked")?(j.Config.SizeFilter.MaxSize=[8191,8191],f.DeleteOneIntelShape(s[1]),s[1]=null):(j.Config.SizeFilter.MinSize=[0,0],f.DeleteOneIntelShape(s[0]),s[0]=null))},_filterRule:function(){j=null,l=o.$("#f_w_presetConV").ptzPreset("get"),j=e[k].filter(function(a){return a.PtzPresetId==l&&"SmokeDetection"==a.Type})[0],j||(e[k].push(a.extend(!0,{},m)),j=e[k][e[k].length-1],j.Type="SmokeDetection",j.PtzPresetId=l),o._renderElements()},_renderElements:function(){o._renderPlugin(),o._renderSizeFilter(j.Config.SizeFilter),o.$("#f_w_open").prop("checked",j.Enable),o.$("#f_w_event").eventHandler("set",j.EventHandler),o.$("#f_w_minDuration").val(j.Config.MinDuration),j.Config.Sensitivity?(o.$("#f_w_sensitivityWrap").show(),o.$("[slider][key=SensitivityV]").slider("value",j.Config.Sensitivity)):o.$("#f_w_sensitivityWrap").hide()},_renderPlugin:function(){if(j){p&&(f.DeleteAllIntelShape(p),p=null,r=null,q=null,s=[]);var a=j.Config.DetectRegion,b={Polygon:a};(0!=a[0][0]||0!=a[0][1]||0!=a[1][0]||0!=a[1][1])&&(b=JSON.encode(b),f.CreateOneIntelShapeContainer(k,"").done(function(a){p=a,o._CreateShape(p,b)}))}},_renderSizeFilter:function(a){a&&o.$("input[inKey]").each(function(b,c){var d=o.$(c),e=d.attr("inKey").split("-");d.val(a[e[0]][e[1]-0])})},_saveElements:function(){j&&(j.Enable=o.$("#f_w_open").prop("checked"),j.EventHandler=o.$("#f_w_event").eventHandler("get"),j.Config.Sensitivity&&(j.Config.Sensitivity=o.$("[slider][key=SensitivityV]").slider("value")))},_getDefault:function(){d.ConfigManager.getDefault("VideoAnalyseRule").done(function(b){e=b,m=a.extend(!0,{},e)[k].filter(function(a){return"SmokeDetection"==a.Type})[0],o.render()}).fail(function(){o.$("#f_w_tipV").tip("error",tl("Defaultfailure"))})},onDefault:function(){return a.each(e[k],function(b,c){if("SmokeDetection"==c.Type&&-1!=c.PtzPresetId){var d=c.PtzPresetId,f=c.Id;c=a.extend(!0,{},m),c.Id=f,c.PtzPresetId=d,e[k][b]=c}}),o._filterRule(),o.$("#f_w_tipV").tip("success",tl("Defaultsuccess")),!1},onRefresh:function(){return d.ConfigManager.getConfig("VideoAnalyseRule").done(function(a){e=a,o._filterRule(),o.$("#f_w_tipV").tip("success",tl("Operateingsuccess"))}).fail(function(){o.$("#f_w_tipV").tip("error",tl("Operateingfailure"))}),!1},onSave:function(){return o._saveElements(),d.ConfigManager.setConfig("VideoAnalyseRule",e).done(function(){o.$("#f_w_tipV").tip("success",tl("Succeed in saving configure"))}).fail(function(){o.$("#f_w_tipV").tip("error",tl("Saving failure"))}),!1}})}),define("thermal",function(require,b,c){var j,n,o,p,q=null,r=null,s=-1,t=[],u={FlashEnable:webApp.ALARM_FLASH,FlashLatch:webApp.ALARM_FLASH,RecordEnable:!0,RecordLatch:!0,MailEnable:!0,SnapshotEnable:!0,PtzLinkEnable:webApp.HasPtz,AlarmOutEnable:!!webApp.ALARM_OUT_NUMBER,AlarmOutLatch:!!webApp.ALARM_OUT_NUMBER,VoiceEnable:webApp.IsAudioFileManager&&webApp.AUDIO_OUT_NUMBER,MMSEnable:webApp.Is3G||webApp.Is4G};c.exports=h.extend({init:function(){q=this,q.$("#f_w_presetConT").ptzPreset(m).ptzPreset("change",q._saveElements,q._filterRule,m),q.initEventHandler(),q.bind(),d.RadiometryManager.getCaps("All",m).done(function(a){r=a}),d.ConfigManager.getDefault("FireWarning").done(function(b){n=a.extend(!0,{},b[m])[0]}),!m&&q.render()},initEventHandler:function(){if(q.$("[cfg]").each(function(a,b){var c=q.$(b),d=c.attr("cfg");u[d]||c.closest(".ui-form-item").remove()}),webApp.HasPtz){if(q.$("[cfg=PtzLinkEnable]").change(function(a){var b=q.$(a.target),c=b.prop("checked");e.get("PTZCaps",!0).done(function(a){p=a;var b=q.$("#f_w_ptzLink");c?(b.parent().show(),b.val(b.is(":has(option[value="+j.EventHandler.PtzLink[0][0]+"])")?j.EventHandler.PtzLink[0][0]:"None")):(b.parent().hide(),b.val("None")),b.change()})}),q.$("#f_w_ptzLink").change(function(a){var b=q.$(a.target),c=b.val(),d=j.EventHandler.PtzLink[0],e=q.$("#f_w_ptzNum"),f=q.$("#f_w_quickFocus");if(a.isTrigger||(d[0]=c),"None"===c)e.parent().hide(),e.numberfield("value",1),f.hide();else if("QuickFocus"===c)q._valueLimit(d[1],0,24),q._valueLimit(d[2],1,300),q.$("#f_w_quickfzoom").numberfield({min:0,max:24,value:d[1],allowNegative:!1,allowDecimal:!1}),q.$("#f_w_quickftime").numberfield({min:1,max:300,value:d[2]?d[2]:10,allowNegative:!1,allowDecimal:!1}),e.parent().hide(),e.numberfield("value",1),f.show();else{var g=p[c+"Min"],h=p[c+"Max"];e.numberfield("min",g),e.numberfield("max",h),q._valueLimit(d[1],g,h),e.numberfield("value",d[1]),e.next().text("("+g+"~"+h+")"),e.parent().show(),f.hide()}return!1}),q.$("#f_w_ptzNum").numberfield({allowDecimal:!1,allowNegative:!1}).blur(function(){return j.EventHandler.PtzLink[0][1]=q.$("#f_w_ptzNum").numberfield("value"),!1}),q.$("#f_w_quickfzoom").blur(function(){return j.EventHandler.PtzLink[0][1]=q.$("#f_w_quickfzoom").numberfield("value"),!1}),q.$("#f_w_quickftime").blur(function(){return j.EventHandler.PtzLink[0][2]=q.$("#f_w_quickftime").numberfield("value"),!1}),webApp.ALARM_OUT_NUMBER>1&&u.AlarmOutEnable){for(var a=q.$("#f_w_alarmchn"),b=0;b<webApp.ALARM_OUT_NUMBER;b++)a.append('<a href="javascript:;" class="ui-channel-item" channle='+b+">"+(b+1)+"</a>");a.click(function(a){return q.$(a.target).toggleClass("ui-channel-item-current"),!1})}q.$("[cfg=FlashLatch],[cfg=RecordLatch],[cfg=AlarmOutLatch]").numberfield({min:10,max:300,allowDecimal:!1,allowNegative:!1})}},bind:function(){q.$("[slider][key=SensitivityT]").slider({min:1,max:100,complete:function(a,b){j&&(j.DetectWindow[s].Sensitivity=b.value)}}),q.$("#f_w_targetDistance").numberfield({min:0,max:1e3,allowNegative:!1,allowDecimal:!1}),q.$("#f_w_anti").numberfield({min:0,max:100,allowNegative:!1,allowDecimal:!1}),q.$(".videodetect-region-item").click(function(){var a=q.$(this);-1!=s&&q._saveResionParam(),a.addClass("videodetect-region-current").siblings().removeClass("videodetect-region-current"),s=a.attr("data-index")-0,f.SetCurrentDrawId(t[s]),q.$("#f_w_regionName").val(j.DetectWindow[s].Name),q.$("#f_w_targetDistance").val(j.DetectWindow[s].TargetSize),q.$("[slider][key=SensitivityT]").slider("value",j.DetectWindow[s].Sensitivity)}),q.$("#f_w_regionName").blur(function(){q.$(this).val().test(/[:"'{}\[\]<>\\,]/)&&(q.$(this).val()=q.$(this).val().replace(/[:"'{}\[\]<>\\,]/g,"")),j.DetectWindow[s].Name=q.$(this).val()}),f.addEvent("OutPutStringInfo",function(b,c){var d=c.split(" ").clean(),e=[];a.each(d,function(a,b){if(b){var c,d=b.split("-"),f=d[0].split("@")[0]-0;if(c=d[1].split(":").map(function(a){return a-0}),c.length<r.FireWarning.DetectRowNum)for(var g=c.length;32>g;g++)c.push(0);e.push({Id:f,Regions:c})}}),a.each(e,function(b,c){a.each(j.DetectWindow,function(a,b){b.Id==c.Id&&(b.Regions=c.Regions)})})})},render:function(){null!=l&&q.$("#f_w_presetConT").ptzPreset("set",k,l),f.cover("#f_w_videoT",function(){var a="Monitor_0"+(k+1);g.chkAuthority(a)?(f.SetVisibleVideoWnd(1,k),f.ConnectRealVideoEx(k,k,0)):(f.SetVisibleVideoWnd(1,k),f.SetVideoWndTip(k,tl("noVideoAuthoity"))),f.SetGridNum(r.FireWarning.DetectRowNum,r.FireWarning.DetectColNum)}),q._getRefresh(!1)},leave:function(){f.hide(),f.SetGridNum(0,0)},onClearAll:function(){f.RemoveAllMonDetectReg()},onDelete:function(){f.RemoveMonDetectReg(t[s]),f.RemoveAllMonDetectReg(t[s])},onSetPeriod:function(){f.hide(),j&&j.EventHandler&&j.EventHandler.TimeSection&&i.open(j.EventHandler.TimeSection).done(function(a){j.EventHandler.TimeSection=a}).always(function(){f.cover("#f_w_videoT")})},_valueLimit:function(a,b,c){b>a&&(a=b),a>c&&(a=c)},_filterRule:function(){l=q.$("#f_w_presetConT").ptzPreset("get"),j=o[k].filter(function(a){return a.PresetId==l})[0],j||(j=a.extend(!0,{},n),j.PresetId=l,o[k].push(j),j=o[k][o[k].length-1]),j.Type=j.Type||"Smoke",q._renderElements()},_renderElements:function(){var b,c=[],d=[1125887,1171711,16369670,65341];t=[],q._fixMotionDetectData(),r.FireWarning.DetectRegionNum.Max.times(function(a){q.$(".videodetect-region-item").eq(a).removeClass("fn-hide"),b=j.DetectWindow[a].Id+"@"+d[a]+"-"+j.DetectWindow[a].Regions.join(":"),c.push(b),t.push(j.DetectWindow[a].Id),s=-1==s?a:s}),f.SetFuntionInfo("MotionDetect",c.join(" ")).done(function(){f.SetCurrentDrawId(t[s])}),q.$("#f_w_regionName").val(j.DetectWindow[s].Name),q.$("#f_w_targetDistance").val(j.DetectWindow[s].TargetSize),q.$("[slider][key=SensitivityT]").slider("value",j.DetectWindow[s].Sensitivity),q.$("#f_w_openT").prop("checked",j.Enable),q.$("#f_w_smokeT").prop("checked","Smoke"==j.Type?!0:!1),q.$("#f_w_fireT").prop("checked","Smoke"==j.Type?!1:!0),q.$("#f_w_modeA").prop("checked","Auto"==j.Mode?!0:!1),q.$("#f_w_modeN").prop("checked","Auto"==j.Mode?!1:!0),q.$("#f_w_anti").val(j.EventHandler.Dejitter),q.$("[cfg]:checkbox").each(function(a,b){var c=q.$(b),d=c.attr("cfg");c.prop("checked",!!j.EventHandler[d]),"PtzLinkEnable"===d&&c.change()}),q.$("[cfg=FlashLatch],[cfg=RecordLatch],[cfg=AlarmOutLatch]").each(function(a,b){var c=q.$(b);c.numberfield("value",j.EventHandler[c.attr("cfg")]||10)}),webApp.ALARM_OUT_NUMBER>1&&u.AlarmOutEnable&&a.isArray(j.EventHandler.AlarmOutChannels)&&(q.$("#f_w_alarmchn").children().removeClass("ui-channel-item-current"),a.each(j.EventHandler.AlarmOutChannels,function(a,b){q.$("#f_w_alarmchn a[channle="+b+"]").addClass("ui-channel-item-current")}))},_fixMotionDetectData:function(){var b=j.DetectWindow||[],c=[],d=[];for(r.FireWarning.DetectRowNum.times(function(){c.push(0)}),r.FireWarning.DetectRegionNum.Max.times(function(a){d.push(a)}),a.each(b,function(a,b){d.erase(b.Id)});b.length<r.FireWarning.DetectRegionNum.Max;){var e=d.shift();b.push({Id:e,Name:"Region"+(e+1),Regions:c,TargetSize:n.DetectWindow[0].TargetSize,Sensitivity:n.DetectWindow[0].Sensitivity})}j.DetectWindow=b},_saveElements:function(){if(q._saveResionParam(),j.Enable=q.$("#f_w_openT").prop("checked"),j.EventHandler.Dejitter=q.$("#f_w_anti").val(),q.$("[cfg]:checkbox").each(function(a,b){var c=q.$(b);j.EventHandler[c.attr("cfg")]=c.prop("checked")}),q.$("[cfg=FlashLatch],[cfg=RecordLatch],[cfg=AlarmOutLatch]").each(function(a,b){var c=q.$(b);j.EventHandler[c.attr("cfg")]=c.numberfield("value")}),webApp.ALARM_OUT_NUMBER>1&&u.AlarmOutEnable){var a=[];q.$("#f_w_alarmchn").children(".ui-channel-item-current").each(function(b,c){a.push(q.$(c).attr("channle")-0)}),j.EventHandler.AlarmOutChannels=a}j.Type=q.$("#f_w_smokeT").prop("checked")?"Smoke":"Fire",j.Mode=q.$("#f_w_modeA").prop("checked")?"Auto":"Normal",j.Row=r.FireWarning.DetectRowNum,j.Col=r.FireWarning.DetectColNum},_saveResionParam:function(){j.DetectWindow[s].Name=q.$("#f_w_regionName").val(),j.DetectWindow[s].TargetSize=q.$("#f_w_targetDistance").val()-0,j.DetectWindow[s].Sensitivity=q.$("[slider][key=SensitivityT]").slider("value")},onDefault:function(){return d.ConfigManager.getDefault("FireWarning").done(function(a){o=a,f.RemoveAllMonDetectReg(),q._filterRule(),q.$("#f_w_tipT").tip("success",tl("Defaultsuccess"))}).fail(function(){q.$("#f_w_tipT").tip("error",tl("Defaultfailure"))}),!1},onRefresh:function(){return q._getRefresh(!0),!1},onSave:function(){return q._saveElements(),d.ConfigManager.setConfig("FireWarning",o).done(function(){q.$("#f_w_tipT").tip("success",tl("Succeed in saving configure"))}).fail(function(){q.$("#f_w_tipT").tip("error",tl("Saving failure"))}),!1},_getRefresh:function(a){d.ConfigManager.getConfig("FireWarning").done(function(b){o=b,f.RemoveAllMonDetectReg(),q._filterRule(),a&&q.$("#f_w_tipT").tip("success",tl("Operateingsuccess"))}).fail(function(){a&&q.$("#f_w_tipT").tip("error",tl("Operateingfailure"))})}})})})}(jQuery);