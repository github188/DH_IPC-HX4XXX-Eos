!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab"),b.exports.prototype.Net_P2P=!!isEnable("is_show_T2UServer")}),define("Net_Network",function(require,b,c){function d(b,c){var c=c.split(".");return a.map(b.split("."),function(a,b){return a&c[b]}).join(".")}function e(b){function c(a){return(a+256).toString(2).substring(1)}var d=a.map(b.split("."),function(a){return c(a-0)}).join("");return-1===d.indexOf("01")}function f(){var b=g();b&&(a(window).off("unload"),L.Reload(b+":"+location.port))}function g(){for(var a=location.hostname.replace(/(^\[)|(\]$)/g,""),b="",c=0,d=A.length;d>c;c++){var e=A[c];if(F[e.Name].IPAddress===a&&F[e.Name].IPAddress!=C[e.Name].IPAddress){b=C[e.Name].IPAddress;break}if(J.v6ToCanonicalForm(G[e.Name].IPAddress)===J.v6ToCanonicalForm(a)&&J.v6ToCanonicalForm(G[e.Name].IPAddress)!==J.v6ToCanonicalForm(D[e.Name].IPAddress)){b="["+D[e.Name].IPAddress+"]";break}}if(!b){var f=C.DefaultInterface;F[f].IPAddress!==C[f].IPAddress&&(b=K.ipv6(a)?"["+a+"]":a)}return b}var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H=require("jsCore/pageBase"),I=require("jsCore/rpc"),J=require("common/common"),K=J.Check,L=require("jsCore/plugin");c.exports=H.extend({init:function(){var b=this;h=b.$("#NN_hostname").textfield({success:a.noop}),i=b.$("[sel-for=onSelectCard]"),j=b.$("[btn-for=onSetDefault]"),k=b.$("[NN_mode]").click(function(c){var d=a(c.target),e=d.attr("NN_mode"),f=d.closest("div.ui-form-item").attr("ipver");"IPv6"===f?(b.disabled(s,"dhcp"===e),b.disabled(t,"dhcp"===e),b.disabled(u,"dhcp"===e)):(b.disabled(n.find("input"),"dhcp"===e),b.disabled(o.find("input"),"dhcp"===e),b.disabled(p.find("input"),"dhcp"===e))}),l=b.$("#NN_macadd input"),m=b.$("[sel-for=onIPVersionChange]"),n=b.$("#NN_IPV4_IP").ipfield({type:"ip",error:function(a,c){"prevent"===c.type?b.tip("warning","ipv4_127"):"firstIPError"==c.type?b.tip("warning","w_ipv4_range"):"lastIPError"==c.type&&b.tip("warning","w_ipv4_range_last")}}),o=b.$("#NN_IPV4_SM").ipfield({type:"mask"}),p=b.$("#NN_IPV4_DG").ipfield({type:"ip",error:function(a,c){"prevent"===c.type?b.tip("warning","ipv4_127"):"firstIPError"==c.type?b.tip("warning","w_ipv4_range"):"lastIPError"==c.type&&b.tip("warning","w_ipv4_range_last")}}),q=b.$("#NN_IPV4_DNS1").ipfield({type:"ip",error:function(a,c){"prevent"===c.type?b.tip("warning","ipv4_127"):"firstIPError"==c.type?b.tip("warning","w_ipv4_range"):"lastIPError"==c.type&&b.tip("warning","w_ipv4_range_last")}}),r=b.$("#NN_IPV4_DNS2").ipfield({type:"ip",error:function(a,c){"prevent"===c.type&&b.tip("warning","ipv4_127")}}),s=b.$("#NN_IPV6_IP").textfield(),t=b.$("#NN_IPV6_IPEx").numberfield({max:128,min:1,allowDecimal:!1,allowNegative:!1}),u=b.$("#NN_IPV6_DG").textfield(),v=b.$("#NN_IPV6_DNS1").textfield(),w=b.$("#NN_IPV6_DNS2").textfield(),x=b.$("#NN_EnableARP"),y=a.validator([{element:h,check:[K.alphaNumLine,K.require],errorMsg:[tl("w_BadstringServerName"),tl("Can not be null")],events:["keyup","keyup"]},{element:s,check:K.ipv6ornull,errorMsg:tl("Bad format IPV6 address ,Gateway or DNS server !"),events:"blur",errorElem:".u-input-error"},{element:u,check:K.ipv6ornull,errorMsg:tl("Bad format IPV6 address ,Gateway or DNS server !"),events:"blur"},{element:v,check:[K.require,K.ipv6],errorMsg:[tl("Can not be null"),tl("Bad format IPV6 address ,Gateway or DNS server !")],events:["keyup","blur"]},{element:w,check:[K.require,K.ipv6],errorMsg:[tl("Can not be null"),tl("Bad format IPV6 address ,Gateway or DNS server !")],events:["keyup","blur"]}]),b.render()},render:function(){var b=this;I.NetApp.getNetInterfaces().done(function(c){A=a.grep(c,function(a){return"3G"!==a.Name}),b._getConfig()}).fail(function(){b.disabled("[btn-for=onSave]",!0),b.tip("error","Operateingfailure")})},_getConfig:function(b){var c=this;I.ConfigManager.getConfig(["PPPoE","Network","IPv6","ARP&Ping"]).done(function(d){B=d[0].result&&d[0].params.table,C=d[1].params.table,D=d[2].params.table,E=d[3].params.table,F=a.extend(!0,{},C),G=a.extend(!0,{},D),c._renderElement(b),c.disabled("[btn-for=onSave]",!1),b&&c.tip("success","Operateingsuccess")}).fail(function(){c.disabled("[btn-for=onSave]",!0),c.tip("error","Operateingfailure")})},_renderElement:function(b){var c=this;c.disabled("[NN_mode],div[ipver] input,[btn-for=onDefault],[btn-for=onSetDefault]",!(!B||!B.Enable)),h.textfield("value",C.Hostname),x.prop("checked",E.SettingIP);var d=i.val();i.empty(),a.each(A,function(a,b){var c=tl("eth0"===b.Name?"w_Lineate":"w_Wireless");b.Name===C.DefaultInterface&&(c+="("+tl("DEFAULT")+")"),i.append("<option value="+b.Name+">"+c+"</option>")}),A.length>1?j.show():j.hide(),b?i.val(d):(i.val(C.DefaultInterface),m.val(/:/.test(location.hostname)?"IPv6":"IPv4").change()),z=null,i.change()},onSave:function(){var b=this;if(y.isInvalid())return b.tip("warning",y.errors()[0].errorMsg);C.Hostname=h.textfield("value"),E.SettingIP=x.prop("checked"),i.change();for(var c=0;c<A.length;c++){if(!e(C[A[c].Name].SubnetMask))return b.tip("warning","w_subnetAddressesWrong");var g=d(C[A[c].Name].IPAddress,C[A[c].Name].SubnetMask),j=d(C[A[c].Name].DefaultGateway,C[A[c].Name].SubnetMask);if(g!==j)return b.tip("warning","w_Not in the same network segment!");for(var k=c+1;k<A.length;k++)if(C[A[c].Name].IPAddress===C[A[k].Name].IPAddress||D[A[c].Name].IPAddress===D[A[k].Name].IPAddress&&D[A[c].Name].IPAddress)return b.tip("warning","w_IP cannot be the same!")}var l=setTimeout(f,3e3);return I.ConfigManager.setConfig(["IPv6","ARP&Ping","Network"],[D,E,C]).done(function(c){isDDNS()?a.each(A,function(a,b){return F[b.Name].IPAddress!==C[b.Name].IPAddress||F[b.Name].DhcpEnable!==C[b.Name].DhcpEnable||G[b.Name].IPAddress!==D[b.Name].IPAddress||G[b.Name].DhcpEnable!==D[b.Name].DhcpEnable?(location.href="http://"+getDDNSMessage().ddnshost,!1):void 0}):c[0].result&&c[1].result&&c[2].result?(b.tip("success","Succeed in saving configure"),f(),F=a.extend(!0,{},C),G=a.extend(!0,{},D)):b.tip("error","Saving failure"),clearTimeout(l)}),!1},onRefresh:function(){return this._getConfig(!0),!1},onDefault:function(){var a=this;return I.ConfigManager.getDefault(["Network","IPv6","ARP&Ping"]).done(function(b){C=b[0].params.table,D=b[1].params.table,E=b[2].params.table,a._renderElement(),a.disabled("[btn-for=onSave]",!1),a.tip("success","Defaultsuccess")}).fail(function(){a.disabled("[btn-for=onSave]",!0),a.tip("error","Defaultfailure")}),!1},onIPVersionChange:function(a){var b=this,c=b.$(a.target).val();return b.$("[ipver]").hide(),b.$("[ipver="+c+"]").show(),!1},onSelectCard:function(b){var c=this,d=a(b.target);if(z){if(y.isInvalid())return d.val(z),c.tip("warning",y.errors()[0].errorMsg);C[z].DhcpEnable="dhcp"===c.$("[name=NN_v4mode]:checked").attr("NN_mode")?!0:!1,C[z].IPAddress=n.ipfield("value"),C[z].SubnetMask=o.ipfield("value"),C[z].DefaultGateway=p.ipfield("value"),C[z].DnsServers[0]=q.ipfield("value"),C[z].DnsServers[1]=r.ipfield("value"),D[z].DhcpEnable="dhcp"===c.$("[name=NN_v6mode]:checked").attr("NN_mode")?!0:!1,D[z].IPAddress=s.textfield("value"),D[z].Prefix=t.numberfield("value"),D[z].DefaultGateway=u.textfield("value"),D[z].DnsServers[0]=v.textfield("value"),D[z].DnsServers[1]=w.textfield("value")}z=d.val();var e=C[z].PhysicalAddress.split(":");l.each(function(a,b){b.value=e[a]});var f=c.$("[name=NN_v4mode][NN_mode="+(C[z].DhcpEnable?"dhcp":"static")+"]").prop("checked",!0);!(B&&B.Enable)&&f.click(),n.ipfield("value",C[z].IPAddress),o.ipfield("value",C[z].SubnetMask),p.ipfield("value",C[z].DefaultGateway),q.ipfield("value",C[z].DnsServers[0]),r.ipfield("value",C[z].DnsServers[1]);var g=c.$("[name=NN_v6mode][NN_mode="+(D[z].DhcpEnable?"dhcp":"static")+"]").prop("checked",!0);return!(B&&B.Enable)&&g.click(),c.$("#NN_linkadd").text(D[z].LinkLocalAddress),s.textfield("value",D[z].IPAddress),t.numberfield("value",D[z].Prefix),u.textfield("value",D[z].DefaultGateway),v.textfield("value",D[z].DnsServers[0]),w.textfield("value",D[z].DnsServers[1]),y.validate(),!1},onSetDefault:function(){var a=this;return F.DefaultInterface=i.val(),I.ConfigManager.setConfig("Network",F).done(function(b){C.DefaultInterface=F.DefaultInterface,a._renderElement(),a.tip("success","Succeed in saving configure"),webApp.isNeedReboot(b)&&webApp.reboot("The configration take effect! The device is restarting now,please reconnect later...")}).fail(function(){a.tip("error","Saving failure")}),!1}})}),define("Net_P2P",function(require,a,b){var c,d=require("jsCore/rpc"),e=require("jsCore/pageBase");b.exports=e.extend({init:function(){var a=this;d.MagicBox.getSerialNo().done(function(b){b&&(a.$("#NP_SN").text(b),a.$("#NP_QR").html(create_qrcode(b)))}),a.render()},render:function(){this._getConfig()},_getConfig:function(a){var b=this;d.ConfigManager.getConfig("T2UServer").done(function(d){c=d,b.$("#NP_T2UEnable").prop("checked",c.Enable),b.disabled("[btn-for=onSave]",!1),a&&b.tip("success","Operateingsuccess")}).fail(function(){b.disabled("[btn-for=onSave]",!0),b.tip("error","Operateingfailure")}),b._getStauts()},_getStauts:function(){var a=this;d.Nat.getTurnStatus().done(function(b){b.IsTurnChannel?a.$("#NP_Status").text(tl("w_online")).addClass("p2p_online"):a.$("#NP_Status").text(tl("w_not_online")).removeClass("p2p_online")})},onSave:function(){var a=this;return c.Enable=a.$("#NP_T2UEnable").prop("checked"),d.ConfigManager.setConfig("T2UServer",c).done(function(){a.tip("success","Succeed in saving configure")}).fail(function(){a.tip("error","Saving failure")}),!1},onRefresh:function(){return this._getConfig(!0),!1},onDefault:function(){var a=this;return d.ConfigManager.getDefault("T2UServer").done(function(b){c=b,a.$("#NP_T2UEnable").prop("checked",c.Enable),a.disabled("[btn-for=onSave]",!1),a.tip("success","Defaultsuccess")}).fail(function(){a.disabled("[btn-for=onSave]",!0),a.tip("error","Defaultfailure")}),a._getStauts(),!1}})})}(jQuery);