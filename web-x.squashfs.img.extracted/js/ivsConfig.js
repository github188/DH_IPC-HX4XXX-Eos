define(function(require){var a,b={},c={},d=require("jsCore/modules/eventHandler"),e=require("jsCore/rpc"),f=require("jsCore/modules/timeSection"),g=require("jsCore/rpcLogin"),h=require("jsCore/plugin"),i=require("jsCore/ability"),j=require("PtzCmd"),k={LeftDetection:[6,3600],TakenAwayDetection:[6,3600],WanderDetection:[1,600],MoveDetection:[6,300],RioterDetection:[10,300],ParkingDetection:[6,300]},l=[],m=[];!function(){var d=Page.ivsConfig={Tab:[],current:null,init:function(){i.get("IntelliTracker").done(function(a){f.init(a&&a.Support),a&&a.Support&&$$('div[data-wrap="TrackEnable"]').removeClass("fn-hide"),j.init("ivsSdPtzWrap",{markScene:a&&a.Support,setPreset:!0})}),i.get("IVSCaps").done(function(a){if(a){for(var c in a.SupportedScenes.Normal.SupportedRules)b[c]=[],l.push(c);-1!==l.indexOf("HeatMap")&&l.splice(l.indexOf("HeatMap"),1),-1!==l.indexOf("VideoAbnormalDetection")&&l.splice(l.indexOf("VideoAbnormalDetection"),1),$("ipcIntellentNew_Global_tab").setStyle("display",""),$("ipcIntellentNew_CrossLineDetection_tab").setStyle("display",""),$("ipcIntellentNew_CrossLineDetection_tab").setProperty("t","Config");var e=a.SupportedScenes&&a.SupportedScenes.Normal.SupportedRules||[];$each(e,function(a,b){a.TriggerTrack&&m.push(b)})}Object.keys(b).length>6&&$$(".ipcIntellentNew_tab_title").setStyle("min-width","80px"),d.Tab["public"].init(),d.Tab.Global.init(),d.translate(),d.bind(),d.render();var f=a.SupportedScenes.Normal.SupportedModuleParams;0==f.Shadow&&jQuery('#Global_TrackForm div[data-cap="Shadow"]').addClass("fn-hide"),0==f.AntiDisturbance&&jQuery('#Global_TrackForm div[data-cap="AntiDisturbance"]').addClass("fn-hide"),0==a.SupportedScenes.Normal.SupportedCalibrateParams.MaxCelibateAreas&&$("ipcIntellentNew_Global_tab").addClass("fn-hide")});"VideoAnalyseRule["+analyseSenceRuleMap.Normal+"]";e.VideoInAnalyse.getTemplateRule("All").done(function(a){d.parseDefaultConfig(a.Normal)}).fail(function(){e.DevVideoAnalyse.getTemplateRule("All").done(function(a){d.parseDefaultConfig(a)}).fail(function(){d.parseDefaultConfig()})}),-1===webApp.DeviceType.indexOf("SD")?jQuery('[data-show="SD"]').addClass("fn-hide"):jQuery('[data-show="IPC"]').addClass("fn-hide")},destory:function(){f.leave(),l.empty()},translate:function(){$("page_ivsConfig").translation()},render:function(){e.ConfigManager.getConfig("VideoAnalyseRule").done(function(b){a=b,$$(".ipcIntellentNew_tab_title.ui-tab-current").fireEvent("click")}),!isEnable("is_show_help")&&$("ipcIntellentNew_help").setStyle("display","none"),f.render()},bind:function(){$("ipcIntellentNew_help").addEvent("click",d._openHelp),$$(".ipcIntellentNew_tab_title").addEvent("click",d._onTabTitleClick)},_onTabTitleClick:function(){var a=this,b=this.getProperty("data-for");d.current!==d.Tab[b]&&d.current&&d.current.leave&&d.current.leave(),setTimeout(function(){$$(".ipcIntellentNew_tab_title").removeClass("ui-tab-current"),$$(".ipcIntellentNew_tab_con").setStyle("display","none"),a.addClass("ui-tab-current");var c=["CrossLineDetection","CrossRegionDetection","LeftDetection","VideoAbnormalDetection","WanderDetection","RioterDetection","MoveDetection","CrossFenceDetection"];if(c.contains(b)){var e="public";b="public"}else var e=b;$("ipcIntellentNew_tab_"+e).setStyle("display","block"),d._hideElement(),d.current=d.Tab[b],d.Tab[b].render()},20)},_hideElement:function(){$("ipcIntellentNew_remark1").setStyle("minWidth","310px"),$("ipcIntellentNew_remark1").setStyle("height","100%"),$("ipcIntellentNew_remark1").setStyle("visibility","hidden"),$("ipcIntellentNew_VideoAbnormalDetection").addClass("fn-width310"),$$(".ipcIntellentNew_VideoAbnormalDetectionButton").removeClass("fn-marl140"),$$(".ipcIntellentNew_VideoAbnormalDetection").setStyle("display",""),$("ipcIntellentNew_VideoAbnormalDetection").addClass("fn-left"),$("ipcIntellentNew_minDuration_wrap").setStyle("display","none"),$("ipcIntellentNew_ruleDirectionWrap").setStyle("display","none"),$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display","none"),$("ipcIntellentNew_RuleType_wrap").setStyle("display","none"),$("ipcIntellentNew_SensitivityWrap").setStyle("display","none"),$("ipcIntellentNew_actionWrap").setStyle("display","none"),$("ipcIntellentNew_fieldset").removeClass("intell-abnormal-fieldset"),$("ipcIntellentNew_fenceDirection_wrap").addClass("fn-hide"),$("ipcIntellentNew_object_filter_ck").setStyle("display",""),$("ipcIntellentNew_target_label").set("text",tl("w_aimFiltrate"))},_openHelp:function(){openHelp("ipcIntellentNewConfig.htm")},parseDefaultConfig:function(a){if(void 0===a||null===a)throw new Error("VideoInAnalyse.getTemplateRule(All) error!");c=a},leave:function(){f.leave(),h.close(),d.current&&d.current.leave&&d.current.leave(),d.current=null}},f={support:!1,status:"",timer:0,init:function(a){a=a===!0?!0:!1,this.support=a,1==a&&$("ipcIntellentNew_lockPtz_wrap").removeClass("fn-hide"),this.Traceer=e.DevIntelliTracker,$("ipcIntellentNew_lockPtz").set("text",tl("unlockPtz")+"(180s)")},render:function(){if(0!=this.support){var a=this;this.Traceer.getLockLeft().done(function(b){0==b?a.setLocktime(180):(a.renderDom(b),setTimeout(function(){a.getLocktime()},1e3))}).fail(function(){setTimeout(function(){remarkDisplay("ipcIntellentNew_remark1",tl("getLockLeft Error"),3e3,1)},1e3)})}},renderDom:function(a){var b=this,c=$("ipcIntellentNew_lockPtz");c.removeEvents("click");var d="";switch(a){case 0:d=tl("lockPtz")+"(180s)",c.addEvent("click",function(){b.setLocktime(180)}),b.status="unlocked";break;default:d=tl("unlockPtz")+"("+a+"s)",c.addEvent("click",function(){b.setLocktime(0)}),b.status="locking"}c.set("text",d)},leave:function(){0!=this.support&&"locking"==this.status&&this.setLocktime(0)},getLocktime:function(){var a=this;this.Traceer.getLockLeft().done(function(b){a.renderDom(b),"locking"==f.status?a.timer=setTimeout(function(){a.getLocktime()},1e3):$clear(a.timer)}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("getLockLeft Error"),3e3,1)})},setLocktime:function(a){var b=this;this.Traceer.setLockDuration(a).done(function(){b.renderDom(a),b.getLocktime()}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("setLockDuration Error"),3e3,1)})}}}(),function(){var a=null,b=null,c=null,d=null,f=null,j=null,k=[],l=1,m=null,n=null,o=null,p=0,q=Page.ivsConfig.Tab.Global={init:function(){q.getTemplate(),q.translate(),q.bind()},getTemplate:function(){e.VideoInAnalyse.getTemplateModule("Normal").done(function(a){n=a.Normal}),e.VideoInAnalyse.getTemplateGlobal().done(function(a){o=a})},translate:function(){},bind:function(){$("ivs_AddScaleArea").addEvents({click:function(){-1!=$("ivs_global_presets").value&&("hidden"==$("ivs_ScaleAreaShow").getStyle("visibility")?(h.SetCalibrateAndRules("CalibrateArea",0,!0),$("ivs_ScaleAreaShow").setStyle("visibility","visible")):remarkDisplay("ivs_global_remark",tl("w_areaError"),3e3,1))}}),$("ivs_DeleteScaleArea").addEvent("click",function(){if($("ivs_ScaleAreaCheck").hasClass("scale_current")){$("ivs_ScaleAreaShow").setStyle("visibility","hidden"),$("ivs_ScaleAreaCheck").removeClass("scale_current"),h.SetCalibrateAndRules("CalibrateArea",0,!1),c=null;var d=q._findCalibrateKey();a[0][d]=c,b=$unlink(a),$("ivs_ScaleListShow").empty(),k.empty(),q.disableStaffOperation()}});var d=$("ivs_scaleContent");$("ivs_AddScale").addEvent("click",function(){if(!this.hasClass("ui-button-disabled")){if("hidden"==$("ivs_ScaleAreaShow").getStyle("visibility")||!c)return void remarkDisplay("ivs_global_remark",tl("w_areadraw"),3e3,1);if(k.contains("Horizontal")&&!$("scaleVertical").checked)return void remarkDisplay("ivs_global_remark",tl("w_horizontalError"),3e3,1);if(3==k.length&&0==$unlink(k).erase("Vertical").length&&$("scaleVertical").checked||4==k.length)return void remarkDisplay("ivs_global_remark",tl("w_verticalError"),3e3,1);if(!c.Staffs&&k.length||c.Staffs&&k.length!=c.Staffs.length)return void remarkDisplay("ivs_global_remark",tl("Please draw shape"),3e3,1);var a=$("scaleVertical").checked?"Vertical":"Horizontal",b=0;k.each(function(c){c==a&&b++}),k.push(a),h.SetCalibrateAndRules(a,0,!0),$("ivs_ScaleListShow").getElements("i.scale_bottom_icon").set("class","scale_main_icon"),d.getElements("a").removeClass("scale_current");var e=new Element("span",{name:a});e.innerHTML='<div class="fn-clear scale-region"><i class="scale_bottom_icon"></i><a href="javascript:;" class="scale_current" data-staffIndex="'+(k.length-1)+'" scale-index="'+b+'" data-type="'+a+'">'+tl("w_"+a)+"</a></div>",e.inject($("ivs_ScaleListShow"))}}),$("ivs_DeleteScale").addEvent("click",function(){if(!this.hasClass("ui-button-disabled")){var a=d.getElement("#ivs_ScaleListShow a.scale_current");if(!a)return void remarkDisplay("ivs_global_remark",tl("pleaseSelectStaff"),3e3,1);var b=a.getProperty("data-type"),e=parseInt(a.getProperty("scale-index"),10),f=parseInt(a.getProperty("data-staffIndex"),10);a.getParent("span").destroy(),k.splice(f,1),c.Staffs.splice(f,1),h.SetCalibrateAndRules(b,e,!1);var g=$$("#ivs_ScaleListShow a"),i=$$("#ivs_ScaleListShow span").getProperty("name"),j=0;k.each(function(a,b){var c=0;"Vertical"==i[b]&&(c=j++),g[b].setProperties({"scale-index":c,"data-staffIndex":b})}),$("ivs_ScaleListShow").getLast()&&$("ivs_ScaleListShow").getLast().getElements("i").set("class","scale_bottom_icon")}}),$("scaleLength").addEvent("change",function(){var a=$("ivs_ScaleListShow").getElement("a.scale_current"),b=this.value-0,d=this;if(isNaN(b)?(this.value=l,b=l):.05>=b?(b=1,this.value=b):b>10&&(b=10,this.value=b),b+""!=this.value){var e=this.getProperty("maxlength");this.value=e?(b+"").substr(0,e-0):b}if(a){var f=(a.getProperty("data-staffindex")-0,a.getProperty("data-type"));c.Staffs.each(function(a){a.Type==f&&(a.Length=d.value-0)})}}).addEvent("keyup",function(){var a=this.value;/[^\d\.]/g.test(a)&&(this.value=a.replace(/[^\d\.]/g,""))}),d.addEvent("click:relay([data-toggle])",function(){var a,b,c,c=this.getProperty("data-toggle"),d=this.getParent().getNext("span");"fold"==c?(a="visible",b="scale_icon_hide",c="unfold"):(a="hidden",b="scale_icon_show",c="fold"),d.setStyle("visibility",a),$("ivs_ScaleIcon").setProperty("class",b),this.setProperty("data-toggle",c)}),d.addEvent("click:relay(a)",function(){var a=this.getProperty("data-type"),b=null,c=this.getProperty("scale-index")||0;c=parseInt(c),d.getElements("a").removeClass("scale_current"),this.addClass("scale_current"),("Horizontal"==a||"Vertical"==a)&&(b=q.getStaff(a,c),$("ivs_global_staffType").getElement("input[value="+a+"]").checked=!0,b&&($("scaleLength").setProperty("disabled",!1).value=b.Length)),h.SelectRule(a,c)}),$("ivs_scaleCheck").addEvent("click",function(){return c&&c.Area&&c.Staffs&&4==c.Staffs.length?($$("#ivs_ScaleListShow a").removeClass("scale_current"),scaleCheckNum=$("ivs_scaleValue").value-0,void h.SetCalibrateAndRules("CheckedLength",scaleCheckNum,!0)):void remarkDisplay("ivs_global_remark",tl("w_scaleAll"),3e3,1)}),$("ivs_global_default").addEvent("click",q._onDefaultClick),$("ivs_global_refresh").addEvent("click",q._onRefreshClick),$("ivs_global_confirm").addEvent("click",q._onConfirmClick),$$("div[data-link]").addEvent("click",function(){var a=this.getProperty("data-link");jQuery("#"+a+" .ui-form-item").toggleClass("fn-hide"),q.slide=new Fx.Slide(a),q.slide.toggle(),this.toggleClass("ui-switch-more")}),jQuery("#Global_IVSForm .ui-form-item").addClass("fn-hide"),new Fx.Slide("Global_IVSForm").hide(),q.sliderInit(),$("VAM_DetectRegion").addEvent("click",q._onParaDetectRegionClick),$("VAM_ExcludeRegion").addEvent("click",q._onParaExcludeRegionClick),q.ocxMode="ParaOrGlobal",$$('#ipcIntellentNew_tab_Global fieldset["data-ocx"]').addEvent("mouseover",function(){var a=this.getProperty("data-ocx");if(a&&q.ocxMode!==a)switch(q.ocxMode=a,a){case"para":q._renderModuleOcx();break;case"global":q._renderCalibrateOcx()}}),r.bind()},sliderInit:function(){q.Slider={},q.Slider.OverlapPercent=new FineSlider("Global_IVS_1_slider","Global_IVS_1_knob",{range:[0,100],snap:!0},"Global_IVS_1_tip","Global_IVS_1_add","Global_IVS_1_sub"),q.Slider.DistLimit=new FineSlider("Global_IVS_2_slider","Global_IVS_2_knob",{range:[0,100],snap:!0},"Global_IVS_2_tip","Global_IVS_2_add","Global_IVS_2_sub"),q.Slider.TimeLimit=new FineSlider("Global_IVS_3_slider","Global_IVS_3_knob",{range:[0,100],snap:!0},"Global_IVS_3_tip","Global_IVS_3_add","Global_IVS_3_sub"),q.Slider.VAMSensitivity=new FineSlider("Global_IVS_4_slider","Global_IVS_4_knob",{range:[1,10],snap:!0},"Global_IVS_4_tip","Global_IVS_4_add","Global_IVS_4_sub")},leave:function(){h.addEvent("OutPutStringInfo",null),h.SetIVSConfig("",0),h.SetIVSConfig("",1),h.hide()},render:function(){h.cover("#ivs_global_video",function(a){h.SetRegionNum(0),h.SetModuleMode(2),g.chkAuthority("Monitor_01")&&h.open(),a&&q._onRefreshClick(!1)}),h.addEvent("OutPutStringInfo",function(a,b){switch(a){case"OutPutGlobalCalibrateInfo":q.outPutGlobalCalibrateInfo(b);break;case"OutPutCheckedInfo":q.outPutCheckedInfo(b);break;case"OutPutModuleRect":q.OutPutModuleRect(b)}}),e.ConfigManager.getConfig(["VideoAnalyseGlobal","VideoAnalyseModule"]).done(function(c){a=c[0].params.table,c[1].result&&(m=c[1].params.table),b=$unlink(a),q.SD.render()}),i.get("IVSCaps").done(function(a){a&&h.SetMaxPntNum(a.MaxPointOfLine,a.MaxPointOfRegion)})},_renderGlobalElements:function(){var b=$("ivs_global_presets").value-0;if(q._renderIVS(b),q._renderTrack(b),0!==a.length){var d=q._findCalibrateKey(),e=a[p][d]||[];if(c=e[0]||null,q._renderScale(),$("scaleVertical").checked=!0,-1===webApp.DeviceType.indexOf("SD"))q.ocxMode="global",q._renderCalibrateOcx();else switch(q.ocxMode){case"para":q._renderModuleOcx();break;case"global":q._renderCalibrateOcx()}}},_findCalibrateKey:function(){var b=$("ivs_global_presets").value-0,c="CalibrateArea";for(var d in a[p])-1!==d.indexOf("Scene")&&a[p][d].PtzPresetId==b&&(c=d.replace("Scene","CalibrateArea"));return c},_renderIVS:function(b){var c=0;if(void 0!=m[c]){for(var d=0;d<m[c].length;d++)if(m[c][d].PtzPresetId==b&&"Normal"==m[c][d].Type){m[c][d].AntiDisturbance===!0?$("VAM_AntiDisturbance_true").checked=!0:$("VAM_AntiDisturbance_false").checked=!0,m[c][d].Shadow===!0?$("VAM_Shadow_true").checked=!0:$("VAM_Shadow_false").checked=!0,q.Slider.VAMSensitivity.set(m[c][d].Sensitivity);break}var e=a[c];for(var f in e)-1!==f.indexOf("Scene")&&e[f].PtzPresetId==b&&e[f].Detail.Track&&(q.Slider.OverlapPercent.set(e[f].Detail.Track.OverlapPercent),q.Slider.DistLimit.set(e[f].Detail.Track.DistLimit),q.Slider.TimeLimit.set(e[f].Detail.Track.TimeLimit))}},_renderTrack:function(){},_buildAnalyseGlobal:function(a){var b={result:!0,params:{table:[a]}};d=JSON.encode(b)},_renderScale:function(){var b=q._findCalibrateKey(),c=a[p][b]||[],d=c[0];if(k.empty(),$("ivs_ScaleListShow").empty(),!d||!d.Area)return $("ivs_ScaleAreaShow").setStyle("visibility","hidden"),void q.disableStaffOperation();$("ivs_ScaleAreaShow").setStyle("visibility","visible"),q.enableStaffOperation();var e="",g=0;d.Staffs&&d.Staffs.each(function(a,b){var c=0;c="Horizontal"==a.Type?0:g++,e+="<span name="+a.Type+'><div class="fn-clear scale-region"><i class="scale_main_icon"></i><a href="javascript:;" data-staffIndex="'+b+'" scale-index="'+c+'" data-type="'+a.Type+'">'+tl("w_"+a.Type)+"</a></div></span>",k.push(a.Type),"Vertical"==a.Type?($("scaleLength").value=a.Length,f=a.Length):j=a.Length}),$("ivs_ScaleListShow").innerHTML=e,$("ivs_ScaleListShow").getLast().getElements("i").set("class","scale_bottom_icon")},getStaff:function(a,b){var d=c.Staffs;if(d){var e=d.filter(function(b){return b.Type==a});return e[b]}},saveCurrentStaff:function(){var a=$("ivs_ScaleListShow").getElement("a.scale_current");if(a&&c.Staffs){var b=parseInt(a.getProperty("data-staffIndex")),d=parseFloat($("scaleLength").value);c.Staffs[b].Length=isNaN(d)?l:d}},outPutGlobalCalibrateInfo:function(b){var d=q._findCalibrateKey();c=JSON.decode(b);var e=c.Staffs,f=a[p][d]||[];if(e){var g=f[0]||{},h=g.Staffs,i=$("scaleLength").value-0;if(h){if(h.each(function(a,b){e[b]&&(e[b].Length=a.Length)}),h.length<e.length){var j=e[e.length-1].Type;e.each(function(a){a.Type==j&&(a.Length=i)}),$("ivs_ScaleListShow").getElements("a").removeClass("scale_current")}}else e[0].Length=i,$("ivs_ScaleListShow").getElements("a").removeClass("scale_current")}else c.Area.length>0&&q.enableStaffOperation();f[0]=c,a[p][d]=f},outPutCheckedInfo:function(a){var b=JSON.decode(a),c=b.CheckedLength[0],d=b.CheckedLength[1];if(0==scaleCheckNum)var f="Horizontal";else var f="Vertical";e.DevVideoAnalyse.testCalibrateWithScreenPoints(f,c,d).done(function(a){h.GetLength(a.toFixed(2))})},disableStaffOperation:function(){$("ivs_global_staffType").getElements("input[name=scaleLine]").setProperty("disabled",!0),$("scaleLength").disabled=!0,$("scaleLength").value=1,$("ivs_AddScale").addClass("ui-button-disabled"),$("ivs_DeleteScale").addClass("ui-button-disabled")},enableStaffOperation:function(){$("ivs_global_staffType").getElements("input[name=scaleLine]").setProperty("disabled",!1),$("scaleLength").disabled=!1,$("ivs_AddScale").removeClass("ui-button-disabled"),$("ivs_DeleteScale").removeClass("ui-button-disabled")},_onDefaultClick:function(){var b=$("ivs_global_presets").value-0;for(var c in a[0])if(-1!==c.indexOf("Scene")&&a[0][c].PtzPresetId==b){var d=c.replace("Scene","CalibrateArea");a[0][d]=null,a[0][c].Detail.Track=jQuery.extend(!0,{},o.Scene.Detail.Track);break}for(var e=0;e<m[0].length;e++)if(m[0][e].PtzPresetId==b&&"Normal"==m[0][e].Type){for(var c in n)"PtzPresetId"!==c&&"Type"!==c&&(m[0][e][c]=$unlink(n[c]));break}remarkDisplay("ivs_global_remark",tl("Defaultsuccess"),3e3,0),q._renderGlobalElements(0)},_saveGlobalScale:function(){c&&q.saveCurrentStaff()},_saveIVS:function(b){for(var c=0,d=0;d<m[c].length;d++)if(m[c][d].PtzPresetId==b&&"Normal"==m[c][d].Type){m[c][d].AntiDisturbance=$("VAM_AntiDisturbance_true").checked,m[c][d].Shadow=$("VAM_Shadow_true").checked,m[c][d].Sensitivity=$("Global_IVS_4_slider").getProperty("title")-0;break}var e=a[c];for(var f in e)-1!==f.indexOf("Scene")&&e[f].PtzPresetId==b&&e[f].Detail.Track&&(e[f].Detail.Track.OverlapPercent=$("Global_IVS_1_slider").getProperty("title")-0,e[f].Detail.Track.DistLimit=$("Global_IVS_2_slider").getProperty("title")-0,e[f].Detail.Track.TimeLimit=$("Global_IVS_3_slider").getProperty("title")-0)},_saveTrack:function(){},_onRefreshClick:function(c){e.ConfigManager.getConfig(["VideoAnalyseGlobal","VideoAnalyseModule"]).done(function(d){common.chkMutilCallRet(d,!0)?(a=d[0].params.table,b=$unlink(a),d[1].result&&(m=d[1].params.table),q._renderGlobalElements(0),c!==!1&&remarkDisplay("ivs_global_remark",tl("Operateingsuccess"),3e3,0)):remarkDisplay("ivs_global_remark",tl("Operateingfailure"),3e3,1)})},_onConfirmClick:function(){var d=c&&c.Area&&c.Staffs&&4==c.Staffs.length;if(!d&&c)return void remarkDisplay("ivs_global_remark",tl("w_scaleAll"),3e3,1);if("visible"==$("ivs_ScaleAreaShow").getStyle("visibility")&&$$("#ivs_ScaleListShow span").length<4)return void remarkDisplay("ivs_global_remark",tl("w_areadraw"),3e3,1);q._saveGlobalScale();var f=$("ivs_global_presets").value-0;q._saveIVS(f),q._saveTrack(f);var g=["VideoAnalyseGlobal","VideoAnalyseModule"],h=[a,m];e.ConfigManager.setConfig(g,h).done(function(c){common.chkMutilCallRet(c)?(b=$unlink(a),remarkDisplay("ivs_global_remark",tl("Succeed in saving configure"),3e3,0),webApp.isNeedReboot(c)&&webApp.reboot("The configration take effect! The device is restarting now,please reconnect later...")):remarkDisplay("ivs_global_remark",tl("IvsGlobalSave"),3e3,1)})},_renderCalibrateOcx:function(){var b=q._findCalibrateKey(),c=a[p][b]||[];q._buildAnalyseGlobal(c),h.SetIVSConfig(d,0),h.SubVideoWndCtrl(12,1)},_clearCalibrateOcx:function(){h.SetIVSConfig("",0)},_bulidModuleJson:function(){for(var a=$("ivs_global_presets").value-0,b={result:!0,params:{table:[[{DetectRegion:null,ExcludeRegion:null,PtzPresetId:0}]]}},c=0;c<m[0].length;c++)if(m[0][c].PtzPresetId===a){b.params.table[0][0].DetectRegion=m[0][c].DetectRegion,b.params.table[0][0].ExcludeRegion=m[0][c].ExcludeRegion||"";break}return JSON.encode(b)},_renderModuleOcx:function(){var a=($("ivs_global_presets").value-0,q._bulidModuleJson());h.SetIVSConfig(a,1),h.AddShape(1,"","",2,0),h.SetCurModule(0)},_clearModuleOcx:function(){h.SetIVSConfig("",1)},_onParaDetectRegionClick:function(){"para"!==q.ocxMode&&(q.ocxMode="para",q._renderModuleOcx()),h.AddDetectionRegion("",0)},_onParaExcludeRegionClick:function(){"para"!==q.ocxMode&&(q.ocxMode="para",q._renderModuleOcx()),h.AddExcludeRegion("",0)},OutPutModuleRect:function(a){for(var b=$("ivs_global_presets").value-0,c=JSON.decode(a),d=0;d<m[0].length;d++)if(m[0][d].PtzPresetId===b){m[0][d].DetectRegion=c.DetectRegion,m[0][d].ExcludeRegion=c.ExcludeRegion;break}}},r=q.SD={bind:function(){$("ivs_global_presets").addEvent("change",function(){var a=this.value-0,b=this.getSelected()[0];b&&b.hasClass("fn-color-ivsGreen")?this.addClass("fn-color-ivsGreen"):this.removeClass("fn-color-ivsGreen"),e.PTZ.gotoPreset(a).always(function(){q._renderGlobalElements()})})},render:function(){this.getPresets(function(){$("ivs_global_presets").fireEvent("change")})},getPresets:function(a){var b=$("ivs_global_presets");return webApp.DeviceType.contains("SD")?void e.PTZ.getPresets().done(function(c){var d=c||[];if(b.empty(),0==d.length)b.options.add(new Option(tl("addPlanFirst"),-1)),remarkDisplay("ivs_global_remark",tl("addPlanFirst"),4e3,2);else{for(var f=[],g=0;g<d.length;g++){var h=new Option(d[g].Name,d[g].Index);$(h).setProperty("title",d[g].Name),1===d[g].Type?($(h).addClass("fn-color-ivsGreen"),b.options.add(h)):($(h).addClass("fn-color-black"),f.push(h))}0==b.length&&b.options.add(new Option(tl("addPlanFirst"),-1))}e.ConfigManager.getConfig("PtzMovement").done(function(a){if("Preset"==a[0].Function){b.value=a[0].Index+1;var c=b.getSelected()[0];c&&c.hasClass("fn-color-ivsGreen")?b.addClass("fn-color-ivsGreen"):b.removeClass("fn-color-ivsGreen"),b.selectedIndex<0&&(b.selectedIndex=0)}}).always(function(){a&&a()})}).fail(function(){$("ivs_global_presets_wrap").addClass("fn-hide"),b.empty(),b.options.add(new Option(tl("addPresetFirst"),0)),a&&a()}):($("ivs_global_presets_wrap").addClass("fn-hide"),b.empty(),b.options.add(new Option(tl("addPresetFirst"),0)),void(a&&a()))}}}(),function(){Page.ivsConfig.Tab.CrossLineDetection={render:function(){$("ipcIntellentNew_ruleDirectionWrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.CrossRegionDetection={render:function(){$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display",""),$("ipcIntellentNew_actionWrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.LeftDetection={render:function(){$("ipcIntellentNew_minDuration_wrap").setStyle("display",""),$("ipcIntellentNew_RuleType_wrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.TakenAwayDetection={render:function(){$("ipcIntellentNew_minDuration_wrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.VideoAbnormalDetection={render:function(){},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.WanderDetection={render:function(){$("ipcIntellentNew_minDuration_wrap").setStyle("display",""),$("ipcIntellentNew_RuleType_wrap").setStyle("display","none")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.RioterDetection={render:function(){$("ipcIntellentNew_minDuration_wrap").setStyle("display",""),$("ipcIntellentNew_RuleType_wrap").setStyle("display","none"),$("ipcIntellentNew_SensitivityWrap").setStyle("display",""),$("ipcIntellentNew_target_label").set("text",tl("minGatherRegion")),$("ipcIntellentNew_object_filter_ck").setStyle("display","none")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.MoveDetection={render:function(){$("ipcIntellentNew_RuleType_wrap").setStyle("display","none"),$("ipcIntellentNew_SensitivityWrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.RetrogradeDetection={render:function(){$("ipcIntellentNew_SensitivityWrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.CrossFenceDetection={render:function(){$("ipcIntellentNew_fenceDirection_wrap").removeClass("fn-hide")},leave:function(){$("ipcIntellentNew_fenceDirection_wrap").addClass("fn-hide"),Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.ParkingDetection={render:function(){$("ipcIntellentNew_minDuration_wrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){function b(a,b,c){function d(){for(var a,d=this.value,e=0,f=0,g=d.length;g>f&&(a=d.charCodeAt(f),e+=127>=a?b.asciiByte||1:b.notAsciiByte||3,!(e>b.maxByte));f++);e>b.maxByte&&(this.value=d.slice(0,f),c&&c())}b=b||{},b.maxlength&&a.setProperty("maxLength",b.maxlength),a.addEvent("keyup",d),a.addEvent("blur",d)}{var j,n,o,p={MaxRect:[8191,8191],MinRect:[0,0]},q=!1,r=!1,s=0,t={},u=null,v=10,w=10,x=Page.ivsConfig.Tab["public"]={init:function(){u=$("ipcIntellentNew_ruleManager"),x.translate(),x.bind(),t=new FineSlider("ipcIntellentNew_Sensitivity_slider","ipcIntellentNew_Sensitivity_knob",{range:[1,10],snap:!0},"ipcIntellentNew_Sensitivity_tip","ipcIntellentNew_Sensitivity_add","ipcIntellentNew_Sensitivity_sub"),i.get("IVSCaps").done(function(a){v=a.MaxRules||10,w=a.SupportedScenes.Normal.MaxRules||10;var b=void 0!==a.LinkPtzSupport?a.LinkPtzSupport:webApp.HasPtz;x.eventHandler=new d("#ipcIntellentNew_eventHandler",{PtzLinkEnable:b})}),e.VideoInAnalyse.getTemplateGlobal().done(function(a){o=a})},translate:function(){},render:function(){$("ipcIntellentNew_left").setStyle("display","block"),$("ipcIntellentNew_VideoAbnormalDetection").getChildren().setStyle("margin-left","470px"),x._disabledDraw(!1),h.cover("#ipcintellentNewVideo",function(a){h.SetRegionNum(0),h.SetModuleMode(2),g.chkAuthority("Monitor_01")&&h.open(),a&&x._onRefreshClick(!1)}),h.addEvent("OutPutStringInfo",function(a,b){switch(a){case"OutPutShapeRect":x.outPutShapeRect(b);break;case"OutPutObjectRect":x.setFilterValue(b);break;case"OutPutRuleRect":x.outPutRuleRect(b)}}),j=$unlink(a),x.SD.render()},renderMinDuration:function(a){var b=k[a]||[1,600];attachLimit("ipcIntellentNew_minDuration",b[0],b[1]),$("ipcIntellentNew_minDurationTip").set("text","("+b[0]+"~"+b[1]+")")},bind:function(){function a(){var a=this.getProperty("data-index"),b=j[analyseSenceRuleMap.Normal][a];b.Enable=this.checked;var c=u.getElements("[data-input]");$("ipcIntellentNew_allRuleEnable").checked=!0;for(var d=0;d<c.length;d++)0==c[d].checked&&($("ipcIntellentNew_allRuleEnable").checked=!1)}function b(){var a=u.getElement(".current");a&&x._saveElements(),this.getSiblings().removeClass("current"),this.addClass("current");var b=this.getProperty("data-index")-0,c=j[analyseSenceRuleMap.Normal][b].Type;x._renderRuleDom(c),x._changeRule(b),x.renderMinDuration(c)}x.SD.bind(),$("ipcIntellentNew_default1").addEvent("click",x._onDefaultClick),$("ipcIntellentNew_refresh1").addEvent("click",x._onRefreshClick),$("ipcIntellentNew_confirm1").addEvent("click",x._onConfirmClick),$("ipcIntellentNew_setButton1").addEvent("click",x._onSetupClick),attachLimit("ipcIntellentNew_TrackTime",5,300),$("ipcIntellentNew_drawRule").addEvent("click",function(){x._drawRuleType(!1)}),$("ipcIntellentNew_clearRule").addEvent("click",function(){var a=x._findIndexNow(),b=j[analyseSenceRuleMap.Normal][a];if(q)return void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1);var c="";switch(b.Type){case"CrossLineDetection":c="DetectLine";break;case"CrossRegionDetection":c="DetectRegion";break;case"WanderDetection":case"MoveDetection":case"RioterDetection":case"LeftDetection":case"TakenAwayDetection":c="DetectRegion";break;case"VideoAbnormalDetection":c="DetectLine";break;case"CrossFenceDetection":c="UpstairsLine";break;default:c="DetectRegion"}"DetectLine"==c?b.Config[c]=[[0,0],[0,0]]:"DetectRegion"==c?b.Config[c]=[[0,0],[0,0],[0,0],[0,0]]:"UpstairsLine"==c&&(b.Config.UpstairsLine=[[0,0],[0,0]],b.Config.DownstairsLine=[[0,0],[0,0]]),x._buildRuleJson(),h.DeleteShape(b.Name),x._drawRuleType(!0),x._renderRule()}),$("ipcIntellentNew_NumberSelect").addEvent("change",x._changeRule),attachLimit("ipcIntellentNew_minDuration",1,600),$("ipcIntellentNew_ruleDirection").addEvent("change",function(){var a=x._findIndexNow(),b=j[analyseSenceRuleMap.Normal][a];b.Config.Direction=this.value,x._changeDiection()}),$("ipcIntellentNew_ruleDirection2").addEvent("change",function(){var a=x._findIndexNow(),b=j[analyseSenceRuleMap.Normal][a];b.Config.Direction=this.value,x._changeDiection()}),$("ipcIntellentNew_fenceDirection").addEvent("change",function(){var a=x._findIndexNow(),b=j[analyseSenceRuleMap.Normal][a];b.Config.Direction=this.value,x._changeDiection()}),$("ipcIntellentNew_drawTarget").addEvent("click",function(){var a=x._findIndexNow(),b=j[analyseSenceRuleMap.Normal][a];if(q)return void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1);if("RioterDetection"==b.Type){if(b.Enable===!1)return;return void(isEmptyRect(b.Config.MinDetectRect)?(h.AddShape(6,"","RuleRect",-1,0),x._disabledDraw(!0)):(h.DeleteShape("RuleRect"),h.SetObjectConfig(JSON.encode({RuleRect:b.Config.MinDetectRect})),h.SetCurShape("RuleRect")))}var c=b.Config.SizeFilter;$("ipcIntellentNew_max").checked?isZeroArray(c.MaxSize)?(h.AddShape(5,"","MaxRect",0,-1),x._disabledDraw(!0)):h.SetCurShape("MaxRect"):isZeroArray(c.MinSize)?(h.AddShape(5,"","MinRect",0,-1),x._disabledDraw(!0)):h.SetCurShape("MinRect")}),$("ipcIntellentNew_clearTarget").addEvent("click",function(){var a=x._findIndexNow(),b=j[analyseSenceRuleMap.Normal][a];return q?void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1):"RioterDetection"==b.Type?(b.Config.MinDetectRect=[[0,0],[0,0]],void(b.Enable&&h.DeleteShape("RuleRect"))):($("ipcIntellentNew_max").checked?b.Config.SizeFilter.MaxSize=[8191,8191]:b.Config.SizeFilter.MinSize=[0,0],void(b.Enable&&(h.DeleteShape("MaxRect"),h.DeleteShape("MinRect"),p.MaxRect=b.Config.SizeFilter.MaxSize,p.MinRect=b.Config.SizeFilter.MinSize,h.SetObjectConfig(JSON.encode(p)),$("ipcIntellentNew_max").checked?h.AddShape(5,"","MaxRect",0,-1):h.AddShape(5,"","MinRect",0,-1),x._disabledDraw(!0,!0))))}),$("ipcIntellentNew_max").addEvent("click",function(){return q?void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1):void h.SetCurShape("MaxRect")}),$("ipcIntellentNew_min").addEvent("click",function(){var a=x._findIndexNow(),b=j[analyseSenceRuleMap.Normal][a];return q?void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1):void(isZeroArray(b.Config.SizeFilter.MinSize)?(h.AddShape(5,"","MinRect",0,-1),x._disabledDraw(!0)):h.SetCurShape("MinRect"))}),$$("#ivs_crd_appear,#ivs_crd_cross").addEvent("click",function(){var a=x._findIndexNow(),b=this.checked,c=this.getProperty("data-val"),d=j[analyseSenceRuleMap.Normal][a].Config;b?d.Action.push(c):d.Action.splice(d.Action.indexOf(c),1),"Cross"==c&&(d.Direction=b?$("ipcIntellentNew_ruleDirection2").value:"",$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display",b?"":"none"),x._changeDiection())}),$("ipcIntellentNew_fieldset").addEvent("click:relay([data-add])",function(){if(!this.hasClass("disabled")){var a="CrossLineDetection";-1==l.indexOf(a)&&(a=l[0]);var b=$unlink(c[a]),d=j[analyseSenceRuleMap.Normal];if(!b)throw remarkDisplay("ipcIntellentNew_remark1",tl("Operateingfailure"),3e3,1),new Error("the rule of "+a+" has no default config");var e=jQuery.extend(!0,{},b),f=[a];"LeftDetection"==a&&f.push("TakenAwayDetection"),e.Name=x.getUniqueName(e.Name,j,f,d),e.PtzPresetId=$("ipcIntellentNew_presets").value-0,d.push(e),x._renderRuleList(d,d.length-1),x._changeRule(d.length-1,!0)}}),u.addEvent("click",function(c){c.target.getProperty("data-del")||(""===c.target.getProperty("data-input")&&a.apply(c.target),b.apply(jQuery(c.target).parents("tr")[0]),x._renderOcx())
}),u.addEvent("click:relay([data-del])",function(){var a,b=this.getProperty("data-del")-0,c=x._findIndexNow(),d=j[analyseSenceRuleMap.Normal];h.DeleteShape(d[b].Name),d.splice(b,1),a=d.length,x._renderRuleList(d,c),x._renderRule(),x._renderOcx()}),u.addEvent("dblclick:relay([data-name])",function(){this.addClass("edit"),this.getElement("input").select()}),u.addEvent("change:relay(select)",function(){var a=x._findIndexNow(),b=j[analyseSenceRuleMap.Normal][a];b.Type=this.value,x._renderRuleDom(b.Type),b.Config=$unlink(c[b.Type].Config),x._changeRule(a)}),$("ipcIntellentNew_allRuleEnable").addEvent("click",function(){var a=u.getElements("[data-input]");if(0==a.length)return void(this.checked=!1);for(var b=j[analyseSenceRuleMap.Normal],c=0;c<a.length;c++){a[c].checked=this.checked;var d=a[c].getProperty("data-index")-0;b[d].Enable=this.checked}var e=u.getElement(".current").getElement("[data-input]").getProperty("data-index");x._changeRule(e)}),u.addEvent("blur:relay(input)",function(){var a=this.getProperty("type");if("checkbox"!=a){var b,c,d=this.value;if(b=this.getParent().removeClass("edit").getProperty("data-name")-0,d){this.getSiblings("span").set("text",d).setProperty("title",d);var e=j[analyseSenceRuleMap.Normal][b];c=e.Name,e.Name=d,h.SetCurShape(c),h.SetCurName(d),h.SetCurShape("save")}}})},leave:function(){h.addEvent("OutPutStringInfo",null),h.SetIVSConfig("",2),h.hide()},getUniqueName:function(a,b,c,d){var e=0,f=[];if(/[^\d]\d{1}$/g.test(a)&&(a=a.substr(0,a.length-1)),a=tl("rule"),null==b[0])return a+"1";for(b.each(function(a){a.each(function(a){c.contains(a.Type)||f.push(a.Name)})}),d.each(function(a){a&&f.push(a.Name)});f.contains(a+ ++e););return a+e},_ruleInitEmpty:function(a){var b=x._findIndexNow();if(-2!=b){x._buildRuleJson();var c=JSON.decode(n).params.table[0][0],d=!1;if(c.Config.DetectLine)0==c.Config.DetectLine[0][0]&&0==c.Config.DetectLine[0][1]&&0==c.Config.DetectLine[1][0]&&0==c.Config.DetectLine[1][1]&&(a||h.DeleteShape(c.Name),d=!0);else if(c.Config.DetectRegion&&"array"==$type(c.Config.DetectRegion)){var e,f=c.Config.DetectRegion,g=!0;for(e=f.length;e--;)if(f[e][0]||f[e][1]){g=!1;break}g&&!a&&h.DeleteShape(c.Name),d=g}else d=!0;return"CrossFenceDetection"==c.Type&&c.Config.DownstairsLine&&c.Config.UpstairsLine&&(d="0,0,0,0"==c.Config.DownstairsLine.toString()&&"0,0,0,0"==c.Config.UpstairsLine.toString()?!0:!1),d}},_renderElements:function(){if(null==j[analyseSenceRuleMap.Normal]&&(j[analyseSenceRuleMap.Normal]=[]),x._disabledDraw(!1),x._renderRuleList(),a=x._findIndexNow(),0>a)return void h.SetIVSConfig("",2);{var a=x._findIndexNow();j[analyseSenceRuleMap.Normal][a]}x._renderRule(),x._renderOcx()},_renderOcx:function(){var a=x._findIndexNow(),b=j[analyseSenceRuleMap.Normal][a];if(b){var c=b.Config.SizeFilter;c&&isZeroArray(c.MaxSize)&&($("ipcIntellentNew_min").disabled=!0),x._buildRuleJson(),h.SetIVSConfig(n,2),h.SetCurShape(b.Name),x._ruleInitEmpty(),b.Enable&&("RioterDetection"==b.Type||(p.MaxRect=c&&c.MaxSize,p.MinRect=c&&c.MinSize,h.SetObjectConfig(JSON.encode(p)),h.SetCurPtzID(0))),h.SetCurShape("save")}},_renderRule:function(){var a=x._findIndexNow(),b=j[analyseSenceRuleMap.Normal][a];if(b){if(x._renderSizeFilter(b.Config.SizeFilter),x.eventHandler.set(b.EventHandler),b.Config.MinDuration&&($("ipcIntellentNew_minDuration").value=b.Config.MinDuration),b.Config.Action){$("ivs_crd_cross").checked=!1,$("ivs_crd_appear").checked=!1,jQuery.each(b.Config.Action,function(a,b){switch(b){case"Cross":$("ivs_crd_cross").checked=!0;break;case"Appear":$("ivs_crd_appear").checked=!0}});var c="none";b.Config.Action.contains("Cross")&&(c=""),$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display",c)}b.Config.Direction&&($("ipcIntellentNew_ruleDirection").value=b.Config.Direction,$("ipcIntellentNew_ruleDirection2").value=b.Config.Direction,$("ipcIntellentNew_fenceDirection").value=b.Config.Direction),b.Config.Sensitivity&&t.set(b.Config.Sensitivity),$("ipcIntellentNew_TrackTime").value=void 0!==b.Config.TrackDuration?b.Config.TrackDuration:30,void 0!==b.TrackEnable&&($("ipcIntellentNew_TrackEnable").checked=b.TrackEnable)}},_renderRuleDom:function(a){Page.ivsConfig._hideElement(),Page.ivsConfig.Tab[a]&&Page.ivsConfig.Tab[a].render(),"VideoAbnormalDetection"==a?jQuery("div[data-emptyDraw]").addClass("fn-hide"):jQuery("div[data-emptyDraw]").removeClass("fn-hide"),x.renderMinDuration(a),m.contains(a)&&webApp.IsIPCIntel?$("ipcIntellentNew_TriggerTrack").removeClass("fn-hide"):webApp.IsIPCIntel&&$("ipcIntellentNew_TriggerTrack").addClass("fn-hide")},_renderSizeFilter:function(a){if(a){var b=["MaxSize-0","MaxSize-1","MinSize-0","MinSize-1"];$("ipcIntellentNew_left").getElements("input[type=text]").each(function(c){var d=c.name;if(b.contains(d)){var e=d.split("-"),f=e[0],g=e[1]-0;c.value=a[f][g]}})}},_renderRuleList:function(a,c){var d=$("ipcIntellentNew_presets").value-0;a=j[analyseSenceRuleMap.Normal]||[];var e=u.getElement("tbody"),f=e.getElement(".current");if(f){var g=f.getProperty("data-index")-0;a[g]&&void 0==c&&(c=g)}for(var h=jQuery("<select></select>"),i=0;i<l.length;i++){var k=jQuery('<option value="'+l[i]+'" title="'+tl(l[i])+'">'+tl(l[i])+"</option>");h.append(k)}{var m='<tr data-index="{index}" data-type="{type}" data-enable="{bool}">                                <td width="8%" class="enable"><input  data-input data-index="{index}" type="checkbox" class="ruleform fn-marl5"></td>                                <td width="10%" class="num fn-textcenter">{No}</td>                                <td width="37%" data-name="{index}" class="fn-indent10 fn-word-wrap">                                    <span class="ui-label fn-text-overflow fn-width120" style="height:20px;" title="{name}">{name}</span>                                    <input data-name class="fn-width110" value="{name}"/></td>                                <td width="37%" data-rule="{index}"><select class="fn-width110">'+h.html()+'<select></td>                                <td width="8%"><span class="ui-button-icon-clear" data-del="{index}"></span></td>                            </tr>',n=[];a.length}e.empty();var o=1;a.each(function(a,b){a&&a.PtzPresetId==d&&-1!==l.indexOf(a.Type)&&n.push(m.substitute({bool:a.Enable,No:o++,index:b,type:a.Type,name:a.Name}))}),e.set("html",n.join("")),b($$("#ipcIntellentNew_ruleManager input[data-name]"),{maxByte:63});var f=e.getElements("tr");$("ipcIntellentNew_allRuleEnable").checked=!!f.length;for(var i=0;i<f.length;i++){var p=f[i].getProperty("data-type"),q=f[i].getElement("select");q.value=p;var r=f[i].getProperty("data-enable"),s=f[i].getElement("input");s.checked="false"===r?!1:!0,"false"===r&&($("ipcIntellentNew_allRuleEnable").checked=!1)}(void 0==c||0==c||0==e.getElements("tr[data-index="+c+"]").length)&&(0!=e.getElements("tr[data-index="+(c+1)+"]").length?c++:c=x._findIndexNow()),e.getElements("tr[data-index="+c+"]").addClass("current");var t=e.getElements("tr[data-index="+c+"]").getProperty("data-type");x._renderRuleDom(t[0]);var r=x._getAddStatus();$("ipcIntellentNew_fieldset").getElements("[data-add]").toggleClass("disabled",r);var v=$("ipcIntellentNew_tab_public");v.getElements("[data-emptyReules]").toggleClass("fn-hide",!f.length),v.getElements("[data-emptyDraw]").toggleClass("fn-invisib",!f.length)},_getAddStatus:function(){for(var a=j[analyseSenceRuleMap.Normal]||[],b=0,c=$("ipcIntellentNew_presets").value-0,d=0;d<a.length;d++)"Normal"==a[d].Class&&a[d].PtzPresetId==c&&b++;return b>=w||a.length>=v||0>=c&&-1!==webApp.DeviceType.indexOf("SD")?!0:!1},_findIndexNow:function(){var a=u.getElement(".current");if(null!==a)return a.getProperty("data-index")-0;var b=u.getElements("tr")[0];return b?b.getProperty("data-index")-0:-2},_buildRuleJson:function(){var a=x._findIndexNow(),b=j[analyseSenceRuleMap.Normal][a],c=jQuery.extend(!0,{},b);delete c.EventHandler;var d={result:!0,params:{table:[[c]]}};return c.PtzPresetId=0,n=JSON.encode(d),JSON.encode(d)},_drawRuleType:function(a){var b=x._findIndexNow(),c=j[analyseSenceRuleMap.Normal][b],d=jQuery("#ipcIntellentNew_ruleManager .current .enable input");if(d[0]&&!d[0].checked)return void remarkDisplay("ipcIntellentNew_remark1",tl("Rule isn't enable!"),3e3,1);if(q)return void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1);var e=c.Name,f=c.Type,g=$("ipcIntellentNew_ruleDirection").selectedIndex,i=$("ipcIntellentNew_presets").value-0,i=0,k=x._ruleInitEmpty(!0);if(!k)return void(a||h.SelectRule(e,0));switch(h.DeleteShape(e),x._disabledDraw(!0),f){case"CrossRegionDetection":g=$("ipcIntellentNew_ruleDirection2").selectedIndex,c.Config.Action.contains("Cross")||(g=-1),h.AddShape(2,f,e,g,i);break;case"CrossLineDetection":h.AddShape(2,f,e,g,i);break;case"CrossFenceDetection":g=$("ipcIntellentNew_fenceDirection").selectedIndex,h.AddShape(2,f,e,g,i);break;default:h.AddShape(2,f,e,-1,i)}},_changeRule:function(a){analyseRuleList=j[analyseSenceRuleMap.Normal]||[],a>=analyseRuleList.length&&(a=analyseRuleList.length-1),s=a,x._disabledDraw(!1),x._renderRule(),x._renderOcx()},_changeDiection:function(){x._renderOcx()},_disabledDraw:function(a,b){q=a,r=b,$("ipcIntellentNew_max").disabled=a,$("ipcIntellentNew_min").disabled=a,$("ipcIntellentNew_NumberSelect").disabled=a,$("ipcIntellentNew_ruleDirection").disabled=a,$("ipcIntellentNew_ruleInputName").disabled=a,$("ivs_crd_cross").disabled=a,$("ipcIntellentNew_ruleDirection2").disabled=a,$("ipcIntellentNew_fenceDirection").disabled=a},_onDefaultClick:function(){e.ConfigManager.getDefault("VideoAnalyseRule").done(function(a){for(var b=$("ipcIntellentNew_presets").value-0,c=j[0].length,d=c-1;d>=0;d--)j[0][d].PtzPresetId===b&&"Normal"==j[0][d].Class&&j[0].erase(j[0][d]);for(var e=a[0],d=0;d<e.length;d++)e[d].PtzPresetId===b&&"Normal"==e[d].Class&&j[0].push(e[d]);x._renderElements(),remarkDisplay("ipcIntellentNew_remark1",tl("Defaultsuccess"),3e3,0)}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("Defaultfailure"),3e3,1)})},_onRefreshClick:function(b){e.ConfigManager.getConfig("VideoAnalyseRule").done(function(c){a=c,j=$unlink(a),x._renderElements(j),b!==!1&&remarkDisplay("ipcIntellentNew_remark1",tl("Operateingsuccess"),3e3,0)}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("Operateingfailure"),3e3,1)})},_onConfirmClick:function(){var b=x._findIndexNow(),c=j[analyseSenceRuleMap.Normal][b];if(r)return void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1);q&&(q=!1,x._disabledDraw(!1),h.DeleteShape(c.Name)),h.SetCurShape("save"),x._saveElements();var d=x._ruleRenameTest();if(!d){a=$unlink(j);var f=x.defCheckGlobal(a);f.done(function(){e.ConfigManager.setConfig("VideoAnalyseRule",a).done(function(){remarkDisplay("ipcIntellentNew_remark1",tl("Succeed in saving configure"),3e3,0),e.ConfigManager.getConfig("VideoAnalyseRule").done(function(b){a=b,j=$unlink(a),x._renderRule()})}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("Saving failure"),3e3,1)})}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("Saving failure"),3e3,1)})}},defCheckGlobal:function(a){return jQuery.Deferred(function(b){-1==webApp.DeviceType.indexOf("SD")?b.resolve():e.ConfigManager.getConfig("VideoAnalyseGlobal").done(function(c){var d=c;null==d[0]&&(d[0]={}),d=x.checkGlobal(d,a),e.ConfigManager.setConfig("VideoAnalyseGlobal",d).done(function(){b.resolve()}).fail(function(){b.reject("setGlobalFailed")})}).fail(function(){b.reject("getGlobalFailed")})})},checkGlobal:function(a,b){var c=0,d=[],e="";for(var f in a[c])-1!==f.indexOf("Scene")&&(d.push(a[c][f].PtzPresetId),e+=f);for(var g=0;g<b[c].length;g++)if(-1==jQuery.inArray(b[c][g].PtzPresetId,d)&&0!==b[c][g].PtzPresetId){for(var h,i=0;255>i&&(h="Scene"+(0==i?"":i),-1!==e.indexOf(h));i++);var j=h.replace("Scene","CalibrateArea");a[c][h]=jQuery.extend(!0,{},o.Scene),a[c][j]=null!==o.CalibrateArea?jQuery.extend(!0,{},o.CalibrateArea):null,a[c][h].PtzPresetId=b[c][g].PtzPresetId,a[c][h].Type="Normal",d.push(b[c][g].PtzPresetId)}return a},_saveElements:function(){var a=x._findIndexNow(),b=j[0][a];if(b){if(b.Config.MinDuration&&"MoveDetection"!=b.Type&&(b.Config.MinDuration=$("ipcIntellentNew_minDuration").value-0),void 0!==b.Config.Direction)switch(b.Type){case"CrossLineDetection":b.Config.Direction=$("ipcIntellentNew_ruleDirection").value;break;case"CrossRegionDetection":b.Config.Action&&b.Config.Action.contains("Cross")&&(b.Config.Direction=$("ipcIntellentNew_ruleDirection2").value);break;case"CrossFenceDetection":b.Config.Direction=$("ipcIntellentNew_fenceDirection").value}return b.Config.Sensitivity&&(b.Config.Sensitivity=t.slider.step),void 0!==b.Config.TrackDuration&&(b.Config.TrackDuration=$("ipcIntellentNew_TrackTime").value-0),void 0!==b.TrackEnable&&(b.TrackEnable=$("ipcIntellentNew_TrackEnable").checked),b.EventHandler=x.eventHandler.get(),b}},_ruleRenameTest:function(){var a=[],b=0,c=0,d=null,e=null,f=!1;return j.each(function(d){d.each(function(d){var e=d.Name;if(!f){var g=a.some(function(a){return a.Name==e?(c=a.Type,b=d.Type,f=!0,!0):!1});g||a.include({Name:e,Type:d.Type})}})}),f&&(d=x._stringShow(c),e=x._stringShow(b),remarkDisplay("ipcIntellentNew_remark1",tl(d)+" "+tl("w_and")+" "+tl(e)+" "+tl("w_groupNameSame"),3e3,1)),f},_stringShow:function(a){return"CrossLineDetection"==a?a="w_CrossLineDetection":"CrossRegionDetection"==a&&(a="w_CrossRegionDetection"),a},_onSetupClick:function(){var a=x._findIndexNow();if(!(-1>=a)){h.hide();var b=j[analyseSenceRuleMap.Normal][a];b&&b.EventHandler&&b.EventHandler.TimeSection&&f.open(b.EventHandler.TimeSection).done(function(a){b.EventHandler.TimeSection=a}).always(function(){h.cover("#ipcintellentNewVideo")})}},outPutShapeRect:function(a){var b=x._findIndexNow(),c=j[analyseSenceRuleMap.Normal][b];x._disabledDraw(!1);var d=c.Type,e=JSON.decode(a);switch(d){case"CrossLineDetection":e.Config.DetectLine&&(c.Config.DetectLine=e.Config.DetectLine);break;case"CrossFenceDetection":e.Config.UpstairsLine&&(c.Config.UpstairsLine=e.Config.UpstairsLine),e.Config.DownstairsLine&&(c.Config.DownstairsLine=e.Config.DownstairsLine);break;case"CrossRegionDetection":case"LeftDetection":case"TakenAwayDetection":if(e.Config.DetectRegion.length<3){x._disabledDraw(!0);break}e.Config.DetectRegion&&(c.Config.DetectRegion=e.Config.DetectRegion);break;default:e.Config.DetectRegion&&(c.Config.DetectRegion=e.Config.DetectRegion)}},outPutRuleRect:function(a){var b=x._findIndexNow(),c=j[analyseSenceRuleMap.Normal][b];x._disabledDraw(!1);var d=JSON.decode(a);d.OutPutRuleRect&&(c.Config.MinDetectRect=d.OutPutRuleRect)},setFilterValue:function(a){var b=x._findIndexNow(),c=j[analyseSenceRuleMap.Normal][b],d=!1,e=JSON.decode(a),f=c.Config.SizeFilter,g=[1,1];e.MinRect?f.MinSize=e.MinRect:e.MaxRect&&(f.MaxSize=e.MaxRect,g=e.MaxRect),d=isZeroArray(g),x._renderSizeFilter(f),x._disabledDraw(d,d)}};x.SD={bind:function(){$("ipcIntellentNew_presets").addEvent("change",function(){var a=this.value-0,b=this.getSelected()[0];b&&b.hasClass("fn-color-ivsGreen")?this.addClass("fn-color-ivsGreen"):this.removeClass("fn-color-ivsGreen"),e.PTZ.gotoPreset(a).always(function(){x._disabledDraw(!1),x._renderElements(j)})})},render:function(){webApp.DeviceType.contains("SD")?this.getPresets(function(){$("ipcIntellentNew_presets").fireEvent("change")}):($$(".sd-line").addClass("fn-hide"),$("ipcIntellentNew_presets_wrap").addClass("fn-hide"),$("ipcIntellentNew_presets").empty(),$("ipcIntellentNew_presets").options.add(new Option(tl("addPresetFirst"),0)),$("ipcIntellentNew_presets").fireEvent("change"))},getPresets:function(a){e.PTZ.getPresets().done(function(b){var c=b||[];if($("ipcIntellentNew_presets").empty(),0==c.length)$("ipcIntellentNew_presets").options.add(new Option(tl("addPresetFirst"),-1)),remarkDisplay("ipcIntellentNew_remark1",tl("addPresetFirst"),4e3,2),a&&a();else{for(var d=[],f=$("ipcIntellentNew_presets"),g=0;g<c.length;g++){var h=new Option(c[g].Name,c[g].Index);$(h).setProperty("title",c[g].Name),1===c[g].Type?($(h).addClass("fn-color-ivsGreen"),f.options.add(h)):($(h).addClass("fn-color-black"),d.push(h))}d.each(function(a){f.options.add(a)}),e.ConfigManager.getConfig("PtzMovement").done(function(a){"Preset"==a[0].Function&&($("ipcIntellentNew_presets").value=a[0].Index+1),$("ipcIntellentNew_presets").selectedIndex<0&&($("ipcIntellentNew_presets").selectedIndex=0)}).always(function(){a&&a()})}}).fail(function(){$$(".sd-line").addClass("fn-hide"),$("ipcIntellentNew_presets_wrap").addClass("fn-hide"),$("ipcIntellentNew_presets").empty(),$("ipcIntellentNew_presets").options.add(new Option(tl("addPresetFirst"),0)),a&&a()})}}}}()}),define("PtzCmd",function(require,a,b){var c=require("jsCore/rpc"),d=new Class({moreFunc:function(){},initialize:function(a,b,c){this.dom=$(a),"function"==typeof c&&(this.moreFunc=c),this.option=b,this.step=5,this.newProtocol=webApp.IsNewProtocol&&-1!==webApp.DeviceType.indexOf("SD"),this.initDom(),this.bind(),this.dom.translation()},initDom:function(){var a='<div class="fn-left fn-width150"><div class="ui-boat fn-marl10"><div class="ui-boat-current"><div class="ui-boat-box-up boat ptzcontrol" data-hover="up" data-cmd="Up"></div><div class="ui-boat-box-left boat ptzcontrol" data-hover="left" data-cmd="Left"></div><div class="ui-boat-box-center" data-hoverEx="img3" data-cmdEx="Default"></div><div class="ui-boat-box-right boat ptzcontrol" data-hover="right" data-cmd="Right"></div><div class="ui-boat-box-down  boat ptzcontrol" data-hover="down" data-cmd="Down"></div></div></div><div class="ui-form-item" ><label class="ui-label fn-width-auto fn-marr4" t="w_Step"></label><select class="ui-select fn-width60" onmousewheel="javascript:return false"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5" selected="">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div></div><div class="fn-left"><div class="ui-ptz-adjust-item fn-clear"><a class="ui-ptz-icon ptzcontrol" data-cmd="ZoomWide"><i class="ui-ptz-icon-less" data-cmd="ZoomWide"></i></a><label class="ui-ptz-adjust-text" t="w_Zoom"></label><a class="ui-ptz-icon ptzcontrol" data-cmd="ZoomTele"><i class="ui-ptz-icon-more" data-cmd="ZoomTele"></i></a></div><div class="ui-ptz-adjust-item fn-clear"><a class="ui-ptz-icon ptzcontrol" data-cmd="FocusFar"><i class="ui-ptz-icon-less" data-cmd="FocusFar"></i></a><label class="ui-ptz-adjust-text" t="W_focus"></label><a class="ui-ptz-icon ptzcontrol" data-cmd="FocusNear"><i class="ui-ptz-icon-more" data-cmd="FocusNear"></i></a></div><div class="ui-ptz-adjust-item fn-clear capIris"><a class="ui-ptz-icon ptzcontrol"  data-cmd="IrisSmall"><i class="ui-ptz-icon-less" data-cmd="IrisSmall"></i></a><label class="ui-ptz-adjust-text" t="w_Iris"></label><a class="ui-ptz-icon ptzcontrol" data-cmd="IrisLarge"><i class="ui-ptz-icon-more" data-cmd="IrisLarge"></i></a></div></div><div class="fn-left fn-padt10 fn-padl20"><div class="ui-form-item" ><a data-cmd="markSceneMaxZoom" href="javascript:;" class=" fn-marb10 ui-button fn-hide markSceneMaxZoom" t="setTrackDynameter"></a></div><div class="ui-form-item" ><a data-cmd="setPreset" href="javascript:;" class="ui-button fn-hide setPreset" t="savePreset"></a></div></div>';this.dom.set("html",a),this.domHover=this.dom.getElement(".ui-boat-current"),c.PTZ.getCurrentProtocolCaps().done(function(a){a&&(a.Zoom===!1&&this.dom.getElement(".capZoom").addClass("fn-hide"),a.Focus===!1&&this.dom.getElement(".capFocus").addClass("fn-hide"),a.Iris===!1&&this.dom.getElement(".capIris").addClass("fn-hide"))}),this.option.markScene===!0&&this.dom.getElements(".markSceneMaxZoom").removeClass("fn-hide"),this.option.setPreset===!0&&this.dom.getElements(".setPreset").removeClass("fn-hide"),this.dom.setStyles({"float":"left","min-width":"400px","min-height":"130px"})},bind:function(){var a=this;a.dom.getElements(".ptzcontrol").each(function(b){b.addEvents({mousedown:function(b){var c=b.target.getProperty("data-cmd");this.addClass("mouse-down"),null!==c&&a.start(c)},mouseout:function(b){var c=b.target.getProperty("data-cmd");this.hasClass("mouse-down")&&(this.removeClass("mouse-down"),a.stop(c),a.moreFunc())},mouseup:function(b){var c=b.target.getProperty("data-cmd");this.removeClass("mouse-down"),null!==c&&(a.stop(c),a.moreFunc())}})}),a.dom.getElements(".boat").each(function(b){b.addEvents({mouseover:function(){if(this.getProperty){var b=this.getProperty("data-hover");null!=b&&a.domHover.addClass("ui-boat-current-"+b)}},mouseout:function(b){if(b.target.getProperty){var c=(b.target.getProperty("data-cmd"),b.target.getProperty("data-hover"));null!=c&&a.domHover.removeClass("ui-boat-current-"+c)}}})}),a.dom.getElement("select").addEvent("change",function(b){a.step=b.target.value-0}),a.dom.getElements("a").addEvent("click",function(){var a=this.getProperty("data-cmd"),b=$("ivs_global_presets").value-0,d=$("ivs_global_presets").getSelected()[0].text;switch(a){case"markSceneMaxZoom":var e=$("ivs_global_presets").value-0,f=0;if(0>=e)return void remarkDisplay("ivs_global_remark",tl("notIvsPresetNow"),6e3,1);c.PTZ.getStatus().done(function(a){var b=a.Postion[2];c.ConfigManager.getConfig("VideoAnalyseModule").done(function(a){for(var d=a,g=0;g<d[f].length;g++)if(d[f][g].PtzPresetId==e){d[f][g].MaxTrackZoom=b;break}c.ConfigManager.setConfig("VideoAnalyseModule",d).done(function(){remarkDisplay("ivs_global_remark",tl("Operateingsuccess"),3e3,0)})})}).fail(function(){remarkDisplay("ivs_global_remark",tl("ptz.getStatusError"),3e3,1)});break;case"setPreset":c.PTZ.setPreset(b,d).done(function(){remarkDisplay("ivs_global_remark",tl("Operateingsuccess"),3e3,0)}).fail(function(){remarkDisplay("ivs_global_remark",tl("Operateingfailure"),3e3,1)})}})},start:function(a){var b=this,d=b.step/8,e=15,f={Up:[0,d,0],Right:[d,0,0],Down:[0,-d,0],Left:[-d,0,0],ZoomWide:[0,0,-d],ZoomTele:[0,0,d],FocusFar:-d,FocusNear:d,IrisSmall:-d,IrisLarge:d};b.newProtocol?-1!==a.indexOf("Focus")?c.PTZ.focusManually(f[a]):-1!==a.indexOf("Iris")?c.PTZ.adjustIris(f[a]):c.PTZ.moveContinuously(f[a],e):c.PTZ.start(a,b.step,0,0,0)},stop:function(a){var b=this;b.newProtocol?-1!==a.indexOf("Focus")?c.PTZ.stopFocus():-1!==a.indexOf("Iris")||c.PTZ.moveContinuously([0,0,0],0):c.PTZ.stop(a,b.step,0,0,0)}});b.exports={init:function(a,b){new d(a,b)},destory:function(){}}});